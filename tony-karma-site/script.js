const $, $ = (sel, ctx = document) => ctx.querySelector(sel), (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

/* State */
const state = {
  user: null, // {email}
};

/* Persisted OpenAI key */
(() => {
  const keyInput = $('#openai-key');
  const saveBtn = $('#save-key');
  const clearBtn = $('#clear-key');

  const saved = localStorage.getItem('openai_key');
  if (saved && keyInput) keyInput.value = saved;

  if (saveBtn) saveBtn.addEventListener('click', () => {
    localStorage.setItem('openai_key', keyInput.value.trim());
    saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
    setTimeout(() => (saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå'), 1200);
  });
  if (clearBtn) clearBtn.addEventListener('click', () => {
    localStorage.removeItem('openai_key');
    if (keyInput) keyInput.value = '';
  });
})();

/* Auth (demo - localStorage only) */
(() => {
  const authStatus = $('#auth-status');
  const btnLogin = $('#btn-login');
  const btnRegister = $('#btn-register');
  const btnLogout = $('#btn-logout');
  const modalLogin = $('#modal-login');
  const modalRegister = $('#modal-register');

  const savedUser = localStorage.getItem('user');
  if (savedUser) {
    state.user = JSON.parse(savedUser);
  }
  renderAuth();

  btnLogin?.addEventListener('click', () => modalLogin.hidden = false);
  btnRegister?.addEventListener('click', () => modalRegister.hidden = false);
  $('[data-close="login"]')?.addEventListener('click', () => modalLogin.hidden = true);
  $('[data-close="register"]')?.addEventListener('click', () => modalRegister.hidden = true);

  $('#do-login')?.addEventListener('click', () => {
    const email = $('#login-email').value.trim().toLowerCase();
    const pass = $('#login-password').value;
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    if (users[email] && users[email].pass === pass) {
      state.user = { email };
      localStorage.setItem('user', JSON.stringify(state.user));
      modalLogin.hidden = true;
      renderAuth();
    } else {
      alert('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }
  });

  $('#do-register')?.addEventListener('click', () => {
    const email = $('#reg-email').value.trim().toLowerCase();
    const pass = $('#reg-password').value;
    if (!email || !pass || pass.length < 8) {
      alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß');
      return;
    }
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    if (users[email]) {
      alert('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß');
      return;
    }
    users[email] = { pass };
    localStorage.setItem('users', JSON.stringify(users));
    state.user = { email };
    localStorage.setItem('user', JSON.stringify(state.user));
    $('#modal-register').hidden = true;
    renderAuth();
  });

  btnLogout?.addEventListener('click', () => {
    state.user = null;
    localStorage.removeItem('user');
    renderAuth();
  });

  function renderAuth() {
    if (state.user) {
      authStatus.textContent = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ${state.user.email}`;
      btnLogin.style.display = 'none';
      btnRegister.style.display = 'none';
      btnLogout.style.display = 'inline-flex';
    } else {
      authStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
      btnLogin.style.display = 'inline-flex';
      btnRegister.style.display = 'inline-flex';
      btnLogout.style.display = 'none';
    }
  }
})();

/* Utils */
const formatDateTh = (d) =>
  d ? new Date(d).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
const dayOfWeekTh = (d) => {
  if (!d) return '';
  return new Date(d).toLocaleDateString('th-TH', { weekday: 'long' });
};
const seeded = (seedStr) => {
  let h = 2166136261 >>> 0;
  for (let i = 0; i < seedStr.length; i++) h ^= seedStr.charCodeAt(i), h += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);
  return () => {
    h += 0x6D2B79F5;
    let t = Math.imul(h ^ (h >>> 15), 1 | h);
    t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
};
const pick = (arr, rnd = Math.random) => arr[Math.floor(rnd() * arr.length)];

/* Presets */
const ASTRO_PRESETS = {
  balanced: '‡πÇ‡∏ó‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏• ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ',
  love: '‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©',
  career: '‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏á‡∏≤‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô',
  health: '‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏¢‡πÉ‡∏à ‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï',
};
const DREAM_PRESETS = {
  balanced: '‡πÇ‡∏ó‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏• ‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡πÉ‡∏à‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô',
  relationship: '‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô',
  career: '‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡∏á‡∏≤‡∏ô ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à',
  healing: '‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡∏¢‡∏ß‡∏¢‡∏≤ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï ‡πÅ‡∏•‡∏∞‡∏™‡∏ï‡∏¥',
};

/* History */
function pushHistory(item) {
  // Gate history for logged-in users only
  const user = JSON.parse(localStorage.getItem('user') || 'null');
  if (!user) return;
  const key = `history:${user.email}`;
  const list = JSON.parse(localStorage.getItem(key) || '[]');
  list.unshift({ ...item, ts: Date.now() });
  localStorage.setItem(key, JSON.stringify(list.slice(0, 100)));
  renderHistory();
}
function renderHistory() {
  const container = $('#history-list');
  if (!container) return;
  const user = JSON.parse(localStorage.getItem('user') || 'null');
  if (!user) { container.innerHTML = '<p class="small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>'; return; }
  const key = `history:${user.email}`;
  const list = JSON.parse(localStorage.getItem(key) || '[]');
  if (!list.length) { container.innerHTML = '<p class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>'; return; }
  container.innerHTML = list.map(it => {
    const dt = new Date(it.ts).toLocaleString('th-TH');
    return `<div class="card" style="margin:8px 0;">
      <div class="small">${dt} ‚Ä¢ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${it.type}</div>
      <div>${it.html}</div>
    </div>`;
  }).join('');
}
$('#clear-history')?.addEventListener('click', () => {
  const user = JSON.parse(localStorage.getItem('user') || 'null');
  if (!user) return;
  localStorage.removeItem(`history:${user.email}`);
  renderHistory();
});
renderHistory();

/* ASTROLOGY */
const zodiac = (month, day) => {
  const z = [
    ['‡∏°‡∏±‡∏á‡∏Å‡∏£', 1, 20], ['‡∏Å‡∏∏‡∏°‡∏†‡πå', 2, 19], ['‡∏°‡∏µ‡∏ô', 3, 20],
    ['‡πÄ‡∏°‡∏©', 4, 20], ['‡∏û‡∏§‡∏©‡∏†', 5, 21], ['‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô', 6, 21],
    ['‡∏Å‡∏£‡∏Å‡∏é', 7, 22], ['‡∏™‡∏¥‡∏á‡∏´‡πå', 8, 23], ['‡∏Å‡∏±‡∏ô‡∏¢‡πå', 9, 23],
    ['‡∏ï‡∏∏‡∏•‡∏¢‡πå', 10, 23], ['‡∏û‡∏¥‡∏à‡∏¥‡∏Å', 11, 22], ['‡∏ò‡∏ô‡∏π', 12, 21],
    ['‡∏°‡∏±‡∏á‡∏Å‡∏£', 12, 31],
  ];
  for (let i = 0; i < z.length - 1; i++) {
    const [name, m, d] = z[i], [nextName, nm, nd] = z[i + 1];
    if ((month === m && day >= d) || (month === nm && day <= nd)) return name;
  }
  return '‡∏°‡∏±‡∏á‡∏Å‡∏£';
};
const zodiacElement = (sign) => {
  const fire = ['‡πÄ‡∏°‡∏©', '‡∏™‡∏¥‡∏á‡∏´‡πå', '‡∏ò‡∏ô‡∏π'];
  const earth = ['‡∏û‡∏§‡∏©‡∏†', '‡∏Å‡∏±‡∏ô‡∏¢‡πå', '‡∏°‡∏±‡∏á‡∏Å‡∏£'];
  const air = ['‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô', '‡∏ï‡∏∏‡∏•‡∏¢‡πå', '‡∏Å‡∏∏‡∏°‡∏†‡πå'];
  const water = ['‡∏Å‡∏£‡∏Å‡∏é', '‡∏û‡∏¥‡∏à‡∏¥‡∏Å', '‡∏°‡∏µ‡∏ô'];
  if (fire.includes(sign)) return '‡πÑ‡∏ü';
  if (earth.includes(sign)) return '‡∏î‡∏¥‡∏ô';
  if (air.includes(sign)) return '‡∏•‡∏°';
  if (water.includes(sign)) return '‡∏ô‡πâ‡∏≥';
  return '‡∏ò‡∏≤‡∏ï‡∏∏';
};
const chineseZodiac = (year) => {
  const names = ['‡∏ä‡∏ß‡∏î(‡∏´‡∏ô‡∏π)','‡∏â‡∏•‡∏π(‡∏ß‡∏±‡∏ß)','‡∏Ç‡∏≤‡∏•(‡πÄ‡∏™‡∏∑‡∏≠)','‡πÄ‡∏ñ‡∏≤‡∏∞(‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢)','‡∏°‡∏∞‡πÇ‡∏£‡∏á(‡∏°‡∏±‡∏á‡∏Å‡∏£)','‡∏°‡∏∞‡πÄ‡∏™‡πá‡∏á(‡∏á‡∏π)','‡∏°‡∏∞‡πÄ‡∏°‡∏µ‡∏¢(‡∏°‡πâ‡∏≤)','‡∏°‡∏∞‡πÅ‡∏°(‡πÅ‡∏û‡∏∞)','‡∏ß‡∏≠‡∏Å(‡∏•‡∏¥‡∏á)','‡∏£‡∏∞‡∏Å‡∏≤(‡πÑ‡∏Å‡πà)','‡∏à‡∏≠(‡∏™‡∏∏‡∏ô‡∏±‡∏Ç)','‡∏Å‡∏∏‡∏ô(‡∏´‡∏°‡∏π)'];
  const offset = (year - 2020) % 12;
  return names[(offset + 12) % 12];
};

$('#astro-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = $('#name').value.trim() || '‡∏ú‡∏π‡πâ‡∏ñ‡∏≤‡∏°';
  const dob = $('#dob').value;
  const tob = $('#tob').value;
  const pob = $('#pob').value.trim();
  const preset = $('#astro-preset')?.value || 'balanced';

  if (!dob) {
    $('#astro-output').innerHTML = `<p class="danger">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</p>`;
    return;
  }
  const date = new Date(dob);
  const sign = zodiac(date.getMonth() + 1, date.getDate());
  const element = zodiacElement(sign);
  const cz = chineseZodiac(date.getFullYear());
  const day = dayOfWeekTh(dob);

  const seed = seeded(`${name}|${dob}|${tob}|${pob}`);
  const love = pick([
    `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏°‡∏µ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏•‡∏µ‡πà‡∏Ñ‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô`,
    `‡πÇ‡∏™‡∏î‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏û‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å`,
    `‡∏Ñ‡∏ß‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏ã‡∏∂‡πà‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ô`,
    `‡∏≠‡∏î‡∏µ‡∏ï‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡∏≠‡∏≤‡∏à‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏à‡∏™‡∏±‡πà‡∏ô ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô`
  ], seed);
  const career = pick([
    `‡∏á‡∏≤‡∏ô‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏î‡∏µ ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏Å‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà ‡∏Ñ‡∏ß‡∏£‡∏Å‡∏•‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢`,
    `‡πÄ‡∏ô‡πâ‡∏ô‡∏ß‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö ‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏ä‡∏±‡∏î‡πÉ‡∏ô ${pick(['2-3 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå','‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô','‡∏ï‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤'], seed)}`,
    `‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏ß‡∏±‡∏î‡∏ú‡∏•`,
    `‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô ‡πÉ‡∏ä‡πâ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô`
  ], seed);
  const money = pick([
    `‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ/‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ`,
    `‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏∏‡πà‡∏°`,
    `‡∏Ñ‡∏ß‡∏£‡∏à‡∏±‡∏î‡∏á‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ‡∏à‡∏∞‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô`,
    `‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏ß‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡πà‡∏á‡∏û‡∏≠‡∏£‡πå‡∏ï ‡πÑ‡∏°‡πà‡πÑ‡∏•‡πà‡∏ï‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡πÅ‡∏™`
  ], seed);
  const health = pick([
    `‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®‡∏ã‡∏¥‡∏ô‡πÇ‡∏î‡∏£‡∏° ‡∏Ñ‡∏ß‡∏£‡∏¢‡∏∑‡∏î‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠`,
    `‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©`,
    `‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏á‡∏≤‡∏ô-‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï`,
    `‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ò‡∏≤‡∏ï‡∏∏ ${element}`
  ], seed);
  const luck = pick([
    `‡πÄ‡∏•‡∏Ç‡∏ô‡∏≥‡πÇ‡∏ä‡∏Ñ: ${Math.floor(seed()*90+10)} ‡∏™‡∏µ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏î‡∏ß‡∏á: ${pick(['‡∏°‡πà‡∏ß‡∏á','‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô','‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß','‡∏ó‡∏≠‡∏á','‡∏ä‡∏°‡∏û‡∏π'], seed)}`,
    `‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏µ: ${pick(['‡πÄ‡∏ä‡πâ‡∏≤','‡∏ö‡πà‡∏≤‡∏¢','‡∏Ñ‡πà‡∏≥'], seed)} ‡∏ß‡∏±‡∏ô${day}`,
    `‡∏™‡∏ß‡∏î‡∏°‡∏ô‡∏ï‡πå/‡∏ó‡∏≥‡∏™‡∏°‡∏≤‡∏ò‡∏¥ ${pick(['9 ‡∏ô‡∏≤‡∏ó‡∏µ','15 ‡∏ô‡∏≤‡∏ó‡∏µ','21 ‡∏ô‡∏≤‡∏ó‡∏µ'], seed)} ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏û‡∏•‡∏±‡∏á‡∏ö‡∏ß‡∏Å`,
    `‡∏ó‡∏≥‡∏ö‡∏∏‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏à‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à`
  ], seed);

  const content = `
    <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î</h4>
    <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${name} ‚Ä¢ <strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</strong> ${formatDateTh(dob)} (${day}) ‚Ä¢ <strong>‡∏£‡∏≤‡∏®‡∏µ:</strong> ${sign} (‡∏ò‡∏≤‡∏ï‡∏∏ ${element}) ‚Ä¢ <strong>‡∏ô‡∏±‡∏Å‡∏©‡∏±‡∏ï‡∏£:</strong> ${cz}${pob ? ` ‚Ä¢ <strong>‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏µ‡πà:</strong> ${pob}` : ''}</p>
    <h4>‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</h4>
    <ul class="list">
      <li><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å:</strong> ${love}</li>
      <li><strong>‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô:</strong> ${career}</li>
      <li><strong>‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô:</strong> ${money}</li>
      <li><strong>‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û:</strong> ${health}</li>
      <li><strong>‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†:</strong> ${luck}</li>
    </ul>
  `;

  const basePrompt = `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏´‡∏°‡∏≠‡∏î‡∏π‡∏ä‡∏∑‡πà‡∏≠ "‡∏≠.‡πÇ‡∏ó‡∏ô‡∏µ‡πà‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Å‡∏£‡∏£‡∏°" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à ‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÇ‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå
‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ñ‡∏≤‡∏°: ‡∏ä‡∏∑‡πà‡∏≠=${name}, ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î=${formatDateTh(dob)} (${day}), ‡∏£‡∏≤‡∏®‡∏µ=${sign} ‡∏ò‡∏≤‡∏ï‡∏∏=${element}, ‡∏ô‡∏±‡∏Å‡∏©‡∏±‡∏ï‡∏£=${cz}, ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î=${tob||'-'}, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î=${pob||'-'}
‡πÇ‡∏ó‡∏ô/‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${ASTRO_PRESETS[preset]}
‡πÇ‡∏õ‡∏£‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ 5 ‡∏î‡πâ‡∏≤‡∏ô: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏† ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ 5-7 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ
  `.trim();

  const key = localStorage.getItem('openai_key')?.trim();
  if (key) {
    try {
      const aiText = await askOpenAI(key, basePrompt);
      const html = content + `<div class="output"><h4>‡πÇ‡∏´‡∏°‡∏î AI</h4><p>${aiText}</p></div>`;
      $('#astro-output').innerHTML = html;
      pushHistory({ type: '‡πÇ‡∏´‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', html });
    } catch (err) {
      $('#astro-output').innerHTML = content + `<p class="small">‡πÇ‡∏´‡∏°‡∏î AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${err.message}</p>`;
      pushHistory({ type: '‡πÇ‡∏´‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', html: content });
    }
  } else {
    // Try serverless proxy if logged in
    try {
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      if (user) {
        const aiText = await askOpenAIProxy(basePrompt);
        const html = content + `<div class="output"><h4>‡πÇ‡∏´‡∏°‡∏î AI (‡∏û‡∏£‡πá‡∏≠‡∏Å‡∏ã‡∏µ)</h4><p>${aiText}</p></div>`;
        $('#astro-output').innerHTML = html;
        pushHistory({ type: '‡πÇ‡∏´‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', html });
        return;
      }
    } catch (e) {
      // ignore and fallback
    }
    $('#astro-output').innerHTML = content;
    pushHistory({ type: '‡πÇ‡∏´‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', html: content });
  }
});

/* TAROT */
const TAROT = [
  { name: 'The Fool (‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)', meaning: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à ‡∏Å‡∏•‡πâ‡∏≤‡∏•‡∏≠‡∏á ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢‡∏≠‡∏≤‡∏à‡∏ô‡∏≥‡πÇ‡∏≠‡∏Å‡∏≤‡∏™' },
  { name: 'The Magician (‡∏ô‡∏±‡∏Å‡∏°‡∏≤‡∏¢‡∏≤‡∏Å‡∏•)', meaning: '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå' },
  { name: 'The High Priestess (‡∏™‡∏ï‡∏£‡∏µ‡∏ô‡∏±‡∏Å‡∏ö‡∏ß‡∏ä)', meaning: '‡πÉ‡∏ä‡πâ‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏ç‡∏≤‡∏ì ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡πà‡∏á‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö' },
  { name: 'The Empress (‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏£‡∏£‡∏î‡∏¥‡∏ô‡∏µ)', meaning: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô' },
  { name: 'The Emperor (‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏£‡∏£‡∏î‡∏¥)', meaning: '‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏†‡∏≤‡∏ß‡∏∞‡∏ú‡∏π‡πâ‡∏ô‡∏≥ ‡∏ß‡∏≤‡∏á‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏•‡∏∞‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤' },
  { name: 'The Hierophant (‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏ô‡∏ï‡∏∞‡∏õ‡∏≤‡∏õ‡∏≤)', meaning: '‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π ‡∏£‡∏∞‡∏ö‡∏ö ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°' },
  { name: 'The Lovers (‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å)', meaning: '‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏°‡∏Å‡∏•‡∏∑‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à' },
  { name: 'The Chariot (‡∏£‡∏ñ‡∏®‡∏∂‡∏Å)', meaning: '‡∏Å‡πâ‡∏≤‡∏ß‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡∏°‡∏µ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ ‡∏ù‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∏‡πà‡∏á‡∏°‡∏±‡πà‡∏ô' },
  { name: 'Strength (‡∏û‡∏•‡∏±‡∏á)', meaning: '‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á ‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô‡πÅ‡∏ï‡πà‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏ô‡πà‡∏ô ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ß' },
  { name: 'The Hermit (‡∏§‡∏≤‡∏©‡∏µ)', meaning: '‡∏ñ‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô' },
  { name: 'Wheel of Fortune (‡∏ß‡∏á‡∏•‡πâ‡∏≠‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤)', meaning: '‡∏ß‡∏á‡∏à‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏´‡∏°‡∏∏‡∏ô‡∏°‡∏≤‡∏ñ‡∏∂‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç' },
  { name: 'Justice (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∏‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏°)', meaning: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ï‡∏£‡∏á ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢ ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à' },
  { name: 'The Hanged Man (‡∏Ñ‡∏ô‡∏ñ‡∏π‡∏Å‡πÅ‡∏Ç‡∏ß‡∏ô)', meaning: '‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏¢‡∏≠‡∏°‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏Å' },
  { name: 'Death (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏¢)', meaning: '‡∏õ‡∏¥‡∏î‡∏â‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å' },
  { name: 'Temperance (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏≠‡∏î‡∏µ)', meaning: '‡∏™‡∏°‡∏î‡∏∏‡∏• ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ' },
  { name: 'The Devil (‡∏õ‡∏µ‡∏®‡∏≤‡∏à)', meaning: '‡∏û‡∏±‡∏ô‡∏ò‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∂‡∏î‡∏ï‡∏¥‡∏î ‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏π‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ‡∏õ‡∏•‡πà‡∏≠‡∏¢' },
  { name: 'The Tower (‡∏´‡∏≠‡∏Ñ‡∏≠‡∏¢)', meaning: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏û‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà' },
  { name: 'The Star (‡∏î‡∏≤‡∏ß)', meaning: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏±‡∏á ‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡∏¢‡∏ß‡∏¢‡∏≤ ‡∏°‡∏≠‡∏á‡πÑ‡∏Å‡∏•‡πÅ‡∏•‡∏∞‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå‡∏Å‡∏±‡∏ö‡∏ï‡∏ô‡πÄ‡∏≠‡∏á' },
  { name: 'The Moon (‡∏û‡∏£‡∏∞‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå)', meaning: '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠ ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏™‡∏π‡∏á‡∏ï‡πà‡∏≥ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏ç‡∏≤‡∏ì' },
  { name: 'The Sun (‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)', meaning: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô' },
  { name: 'Judgement (‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤)', meaning: '‡∏ï‡∏∑‡πà‡∏ô‡∏£‡∏π‡πâ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏û‡∏•‡∏±‡∏á ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏≠‡∏î‡∏µ‡∏ï' },
  { name: 'The World (‡πÇ‡∏•‡∏Å)', meaning: '‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏ß‡∏á‡∏à‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà' },
];

$('#draw-tarot')?.addEventListener('click', () => {
  const n = parseInt($('#tarot-count').value, 10);
  const rnd = seeded(String(Date.now()));
  const cards = [];
  for (let i = 0; i < n; i++) {
    const idx = Math.floor(rnd()*TAROT.length);
    const upright = rnd() > 0.5;
    const data = TAROT[idx];
    cards.push({ ...data, upright });
  }
  const grid = $('#tarot-output');
  grid.innerHTML = '';
  cards.forEach((c, i) => {
    const el = document.createElement('div');
    el.className = 'tarot-card';
    el.innerHTML = `
      <h4>${n === 3 ? ['‡∏≠‡∏î‡∏µ‡∏ï','‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô','‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï'][i] + ' ‚Ä¢ ' : ''}${c.name} ${c.upright ? '(‡πÑ‡∏û‡πà‡∏ï‡∏±‡πâ‡∏á)' : '(‡πÑ‡∏û‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏±‡∏ß)'}</h4>
      <p>${c.upright ? c.meaning : invertMeaning(c.meaning)}</p>
      <p class="minor">‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${adviceFromTarot(c)}</p>
    `;
    grid.appendChild(el);
  });
  pushHistory({ type: '‡πÑ‡∏û‡πà‡∏¢‡∏¥‡∏õ‡∏ã‡∏µ', html: grid.innerHTML });
});

const invertMeaning = (m) => {
  return '‡∏û‡∏•‡∏±‡∏á‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏á‡∏≤: ' + m.replace(' ', ' ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô ');
};
const adviceFromTarot = (c) => {
  const base = [
    '‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô',
    '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏á‡∏≤‡∏ô-‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï',
    '‡∏à‡∏±‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡πÜ',
    '‡∏ù‡∏∂‡∏Å‡∏™‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á',
    '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡∏Å‡πâ‡∏≤‡∏ß'
  ];
  return pick(base);
};

/* SIEMSI */
const SIEMSI = [
  { no: 1, tone: '‡∏î‡∏µ‡∏°‡∏≤‡∏Å', text: '‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏´‡∏≤‡∏Å‡πÄ‡∏û‡∏µ‡∏¢‡∏£‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ö‡∏£‡πâ‡∏≠‡∏ô' },
  { no: 2, tone: '‡∏î‡∏µ', text: '‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì' },
  { no: 3, tone: '‡∏Å‡∏•‡∏≤‡∏á', text: '‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏ö ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô' },
  { no: 4, tone: '‡∏û‡∏≠‡πÉ‡∏ä‡πâ', text: '‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ ‡∏ó‡∏≥‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏à‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢' },
  { no: 5, tone: '‡∏£‡∏∞‡∏ß‡∏±‡∏á', text: '‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏∑‡∏≠ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' },
  { no: 6, tone: '‡∏î‡∏µ', text: '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà' },
  { no: 7, tone: '‡∏Å‡∏•‡∏≤‡∏á', text: '‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô ‡∏ü‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' },
  { no: 8, tone: '‡∏î‡∏µ‡∏°‡∏≤‡∏Å', text: '‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏õ‡∏£‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏∞' },
  { no: 9, tone: '‡∏£‡∏∞‡∏ß‡∏±‡∏á', text: '‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏à‡∏£‡πâ‡∏≠‡∏ô ‡∏≠‡∏î‡∏ó‡∏ô‡∏à‡∏∞‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ' },
  { no: 10, tone: '‡∏î‡∏µ', text: '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏à‡∏≠‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏´‡∏°‡πà ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏µ' },
  { no: 11, tone: '‡∏Å‡∏•‡∏≤‡∏á', text: '‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' },
  { no: 12, tone: '‡∏î‡∏µ‡∏°‡∏≤‡∏Å', text: '‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏à‡πÉ‡∏™ ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô' },
  { no: 13, tone: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô', text: '‡∏™‡∏¥‡πà‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏â‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏•‡πâ‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ' },
  { no: 14, tone: '‡∏û‡∏≠‡∏î‡∏µ', text: '‡∏ó‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏∞‡∏û‡∏≤‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢' },
  { no: 15, tone: '‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô', text: '‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∂‡∏î‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡∏ô‡πâ‡∏≠‡∏¢' },
  { no: 16, tone: '‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢', text: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ú‡∏ä‡∏¥‡∏ç ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á' },
  { no: 17, tone: '‡∏´‡∏ß‡∏±‡∏á', text: '‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏•‡∏±‡∏á‡πÉ‡∏à ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏î‡∏¥‡∏ô‡∏ï‡πà‡∏≠' },
  { no: 18, tone: '‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠', text: '‡∏≠‡∏¢‡πà‡∏≤‡∏£‡∏µ‡∏ö‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô ‡πÄ‡∏õ‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å' },
  { no: 19, tone: '‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô', text: '‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ö‡∏ß‡∏Å‡∏™‡∏π‡∏á ‡∏ó‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏î‡∏µ' },
  { no: 20, tone: '‡∏ï‡∏∑‡πà‡∏ô‡∏£‡∏π‡πâ', text: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Å‡πà‡∏≤ ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤' },
];

$('#shake-siemsi')?.addEventListener('click', () => {
  const s = pick(SIEMSI);
  $('#siemsi-output').innerHTML = `
    <p>‡πÉ‡∏ö‡∏ó‡∏µ‡πà <strong>${s.no}</strong> (${s.tone})</p>
    <p>${s.text}</p>
  `;
  pushHistory({ type: '‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ', html: $('#siemsi-output').innerHTML });
});

/* DICE */
$('#roll-dice')?.addEventListener('click', () => {
  const diceEl = document.createElement('span');
  diceEl.className = 'dice spin';
  diceEl.textContent = 'üé≤';
  $('#dice-output').innerHTML = '';
  $('#dice-output').appendChild(diceEl);
  setTimeout(() => {
    diceEl.classList.remove('spin');
    const n = Math.floor(Math.random()*6)+1;
    const advice = [
      '‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏à‡∏ö',
      '‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô',
      '‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô',
      '‡∏û‡∏±‡∏Å‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏•‡∏∏‡∏¢‡∏ï‡πà‡∏≠',
      '‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ',
      '‡∏•‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ú‡∏±‡∏î‡∏ß‡∏±‡∏ô'
    ][n-1];
    $('#dice-output').innerHTML = `<p>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≠‡∏¢: <strong>${n}</strong></p><p>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${advice}</p>`;
    pushHistory({ type: '‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤', html: $('#dice-output').innerHTML });
  }, 500);
});

/* DREAM */
const DREAM_MAP = [
  { keys: ['‡∏á‡∏π','‡πÄ‡∏•‡∏∑‡πâ‡∏≠‡∏¢'], topic: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å/‡∏û‡∏±‡∏ô‡∏ò‡∏∞', meaning: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏±‡∏ß ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡∏∂‡∏î‡∏≠‡∏±‡∏î' },
  { keys: ['‡∏ü‡∏±‡∏ô','‡∏ü‡∏±‡∏ô‡∏´‡∏±‡∏Å'], topic: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à', meaning: '‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏†‡∏≤‡∏û‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡πÉ‡∏à' },
  { keys: ['‡∏û‡∏£‡∏∞','‡∏ß‡∏±‡∏î'], topic: '‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì', meaning: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏á‡∏ö ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≥‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏™‡∏±‡πâ‡∏ô‡πÜ' },
  { keys: ['‡πÄ‡∏á‡∏¥‡∏ô','‡∏ó‡∏≠‡∏á'], topic: '‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô', meaning: '‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ó‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢' },
  { keys: ['‡∏™‡∏∏‡∏ô‡∏±‡∏Ç','‡πÅ‡∏°‡∏ß'], topic: '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏±‡∏Å‡∏î‡∏µ', meaning: '‡∏Ñ‡∏ô‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠' },
  { keys: ['‡∏ô‡πâ‡∏≥','‡∏ù‡∏ô','‡∏ó‡∏∞‡πÄ‡∏•'], topic: '‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå', meaning: '‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á ‡∏ü‡∏±‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô' },
  { keys: ['‡∏Ç‡∏µ‡πâ','‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢'], topic: '‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡∏≤‡∏á', meaning: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏°‡πà' },
  { keys: ['‡∏ï‡∏≤‡∏¢','‡∏®‡∏û'], topic: '‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á', meaning: '‡∏™‡∏¥‡πà‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏â‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà' },
  { keys: ['‡πÄ‡∏î‡πá‡∏Å','‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'], topic: '‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ', meaning: '‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏ú‡∏•‡∏î‡∏µ' },
  { keys: ['‡∏ö‡πâ‡∏≤‡∏ô','‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß'], topic: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á', meaning: '‡∏î‡∏π‡πÅ‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô' },
];

$('#dream-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const text = $('#dream-text').value.trim();
  const preset = $('#dream-preset')?.value || 'balanced';
  if (!text) {
    $('#dream-output').innerHTML = `<p class="danger">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ù‡∏±‡∏ô</p>`;
    return;
  }
  const lower = text.toLowerCase();
  const hit = DREAM_MAP.filter(m => m.keys.some(k => lower.includes(k)));
  const baseMsg = hit.length
    ? hit.map(m => `‚Ä¢ ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: <strong>${m.topic}</strong> ‚Äî ${m.meaning}`).join('<br>')
    : '‡∏ù‡∏±‡∏ô‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç';
  const advice = pick([
    '‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ù‡∏±‡∏ô 3 ‡∏Ñ‡∏∑‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ã‡πâ‡∏≥',
    '‡∏ó‡∏≥‡∏™‡∏°‡∏≤‡∏ò‡∏¥ 9 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå',
    '‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠'
  ]);
  const templated = `<p>${baseMsg}</p><p class="minor">‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${advice}</p>`;

  const prompt = `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏´‡∏°‡∏≠‡∏î‡∏π "‡∏≠.‡πÇ‡∏ó‡∏ô‡∏µ‡πà‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Å‡∏£‡∏£‡∏°" ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ù‡∏±‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ
‡∏ö‡∏£‡∏¥‡∏ö‡∏ó/‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${DREAM_PRESETS[preset]}
‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ù‡∏±‡∏ô: """${text}"""
‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡πÉ‡∏à ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ 4-6 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
  `.trim();

  const key = localStorage.getItem('openai_key')?.trim();
  if (key) {
    try {
      const aiText = await askOpenAI(key, prompt);
      const html = templated + `<div class="output"><h4>‡πÇ‡∏´‡∏°‡∏î AI</h4><p>${aiText}</p></div>`;
      $('#dream-output').innerHTML = html;
      pushHistory({ type: '‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ù‡∏±‡∏ô', html });
    } catch (err) {
      $('#dream-output').innerHTML = templated + `<p class="small">‡πÇ‡∏´‡∏°‡∏î AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${err.message}</p>`;
      pushHistory({ type: '‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ù‡∏±‡∏ô', html: templated });
    }
  } else {
    try {
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      if (user) {
        const aiText = await askOpenAIProxy(prompt);
        const html = templated + `<div class="output"><h4>‡πÇ‡∏´‡∏°‡∏î AI (‡∏û‡∏£‡πá‡∏≠‡∏Å‡∏ã‡∏µ)</h4><p>${aiText}</p></div>`;
        $('#dream-output').innerHTML = html;
        pushHistory({ type: '‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ù‡∏±‡∏ô', html });
        return;
      }
    } catch (e) {}
    $('#dream-output').innerHTML = templated;
    pushHistory({ type: '‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ù‡∏±‡∏ô', html: templated });
  }
});

/* Payment copy */
$('#copy-account')?.addEventListener('click', () => {
  const t = $('#scb-account').textContent.trim();
  navigator.clipboard.writeText(t);
});

/* OpenAI helper - direct (unsafe for production) */
async function askOpenAI(key, prompt) {
  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${key}`,
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: [
        { role: 'system', content: '‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≠‡∏î‡∏π‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à ‡πÅ‡∏•‡∏∞‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ' },
        { role: 'user', content: prompt }
      ],
      temperature: 0.7,
    })
  });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(text || `HTTP ${res.status}`);
  }
  const data = await res.json();
  const choice = data.choices?.[0]?.message?.content;
  return choice || '';
}

/* OpenAI helper - serverless proxy */
async function askOpenAIProxy(prompt) {
  const res = await fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt }),
  });
  if (!res.ok) throw new Error(await res.text());
  const data = await res.json();
  return data.text || '';
}