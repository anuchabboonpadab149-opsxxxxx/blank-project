<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fortune - ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">üîÆ Fortune</div>
      <nav>
        <a href="#" id="menu-help">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</a>
      </nav>
    </header>

    <div class="hero card">
      <div class="badge">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤ ‚Ä¢ ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ ‚Ä¢ ‡πÑ‡∏û‡πà‡∏¢‡∏¥‡∏õ‡∏ã‡∏µ</div>
      <h2>‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h2>
      <p class="muted">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à ‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
    </div>

    <section id="temples" class="temple-list">
      <!-- dynamically rendered temple plaques -->
    </section>

    <div id="flow" class="hidden">
      <div id="progress" class="stepper">
        <div class="step" data-step="1"><div class="dot">1</div><div class="label">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div></div>
        <div class="step" data-step="2"><div class="dot">2</div><div class="label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</div></div>
        <div class="step" data-step="3"><div class="dot">3</div><div class="label">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div></div>
        <div class="step" data-step="4"><div class="dot">4</div><div class="label">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢</div></div>
        <div class="step" data-step="5"><div class="dot">5</div><div class="label">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div></div>
      </div>

    <!-- STEP 1 -->
    <section id="step-1" class="card split">
      <div>
        <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <div class="row">
          <div>
            <h4 class="muted">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h4>
            <input id="reg-email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" />
            <input id="reg-pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
            <button class="primary" onclick="register()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
          </div>
          <div>
            <h4 class="muted">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h4>
            <input id="login-email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" />
            <input id="login-pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
            <button class="primary" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤</button>
          </div>
        </div>
      </div>
      <aside class="card">
        <div id="me" class="hidden">
          <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="badge">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span></p>
          <p class="muted">User ID: <span id="me-id"></span></p>
          <button class="ghost" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        <div id="me-guest">
          <p class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>
      </aside>
    </section>

    <!-- STEP 2 -->
    <section id="step-2" class="card">
      <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</h3>
      <p class="muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‚Äú‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‚Äù</p>
      <div id="packages" class="grid"></div>
    </section>

    <!-- STEP 3 -->
    <section id="step-3" class="card hidden">
      <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô PromptPay</h3>
      <p class="muted">‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
      <div class="row">
        <div>
          <div id="qr" class="qr"></div>
          <div style="margin-top:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="badge" id="tx-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: -</span>
          </div>
        </div>
        <div>
          <input id="slip-url" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á URL)" style="width: 100%;" />
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="primary" onclick="verify()">‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
            <button class="ghost" onclick="loadCredits()">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
          </div>
          <p class="muted" style="margin-top:6px">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
        </div>
      </div>
    </section>

    <!-- STEP 4 -->
    <section id="step-4" class="card hidden">
      <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 4: ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</h3>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <span class="badge">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b id="credits">-</b></span>
        <button class="ghost" onclick="loadCredits()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</button>
      </div>
      <div class="row" style="margin-top:12px">
        <div>
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</label>
          <select id="source"></select>
          <div style="margin-top:8px">
            <button class="primary" onclick="draw()">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢ 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
          </div>
        </div>
        <div id="drawn" class="hidden">
          <h4 id="result-key"></h4>
          <p id="verse"></p>
          <p><b>‡∏™‡∏£‡∏∏‡∏õ:</b> <span id="summary"></span></p>
          <p class="muted">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢: <b id="balance"></b></p>
        </div>
      </div>
    </section>

    <!-- STEP 5 -->
    <section id="step-5" class="card hidden">
      <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 5: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠/‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="ghost" onclick="loadHistory()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
      </div>
      <pre id="history" class="muted" style="margin-top:10px"></pre>
    </section>
    </div>

    <div class="footer">¬© Fortune. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</div>
  </div>

  <script src="config.js"></script>
  <script>
    const API = window.APP_CONFIG.API_BASE;
    let token = localStorage.getItem('token') || '';
    let userId = localStorage.getItem('user_id') || '';
    let currentTx = null;
    let selectedSourceId = null;

    const auth = () => token ? { 'Authorization': 'Bearer ' + token } : {};
    function showFlow(){ document.getElementById('flow').classList.remove('hidden'); }

    function goto(step){
      // show panel
      for (let i=1;i<=5;i++){
        const sec = document.getElementById('step-'+i);
        if (!sec) continue;
        if (i === step) sec.classList.remove('hidden'); else sec.classList.add('hidden');
      }
      // update stepper
      const steps = document.querySelectorAll('#progress .step');
      steps.forEach(s => {
        const n = parseInt(s.dataset.step,10);
        s.classList.remove('active','done');
        if (n === step) s.classList.add('active');
        else if (n < step) s.classList.add('done');
      });
    }
    function canGo(step){
      // gate conditions
      if (step>=2 && !token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return false; }
      return true;
    }
    function setStep(step){ if (canGo(step)) goto(step); }

    function ensureSelectSource(){
      if (selectedSourceId) {
        const el = document.getElementById('source');
        const opt = [...el.options].find(o => parseInt(o.value,10) === selectedSourceId);
        if (opt) el.value = String(selectedSourceId);
      }
    }
    function setLoggedIn(id, tok) {
      userId = id; token = tok;
      localStorage.setItem('user_id', id);
      localStorage.setItem('token', tok);
      document.getElementById('me').classList.remove('hidden');
      document.getElementById('me-guest').classList.add('hidden');
      document.getElementById('me-id').textContent = id;
      loadCredits();
      loadPackages();
      loadSources().then(()=>{
        ensureSelectSource();
        if (selectedSourceId) setStep(4);
      });
    }

    async function register() {
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-pass').value;
      if (!email || !password) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
      const r = await fetch(API + '/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
      const data = await r.json();
      if (r.ok) setLoggedIn(data.user_id, data.token); else alert(JSON.stringify(data));
    }
    async function login() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-pass').value;
      if (!email || !password) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
      const r = await fetch(API + '/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
      const data = await r.json();
      if (r.ok) setLoggedIn(data.user_id, data.token); else alert(JSON.stringify(data));
    }
    function logout() {
      localStorage.removeItem('user_id'); localStorage.removeItem('token');
      token=''; userId='';
      currentTx=null;
      document.getElementById('me').classList.add('hidden');
      document.getElementById('me-guest').classList.remove('hidden');
      setStep(1);
    }

    async function loadPackages() {
      const r = await fetch(API + '/packages');
      const data = await r.json();
      const el = document.getElementById('packages');
      el.innerHTML = '';
      data.forEach(pkg => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="pkg">
            <div><b>${pkg.name}</b> <span class="muted">(${pkg.credits} ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)</span> ${pkg.is_best_seller ? '<span class="best">Best Seller</span>' : ''}</div>
            <div><b>${pkg.price.toFixed(2)}</b> ‡∏ö‡∏≤‡∏ó</div>
          </div>
          <button class="primary" ${!token ? 'disabled' : ''} onclick="buy(${pkg.id})">‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏ô‡∏µ‡πâ</button>
        `;
        el.appendChild(div);
      });
    }

    async function buy(package_id) {
      if (!token) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
      const r = await fetch(API + '/payment/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...auth() },
        body: JSON.stringify({ package_id })
      });
      const data = await r.json();
      if (!r.ok) return alert(JSON.stringify(data));
      currentTx = data.transaction_id;
      document.getElementById('qr').innerHTML = `<img src="${data.qr_code_url}" width="220" height="220" />`;
      document.getElementById('tx-status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: CREATED';
      setStep(3);
    }

    async function verify() {
      const slip = document.getElementById('slip-url').value.trim();
      if (!currentTx) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠');
      if (!slip) return alert('‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
      const r = await fetch(API + '/payment/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...auth() },
        body: JSON.stringify({ transaction_id: currentTx, slip_image_url: slip })
      });
      const data = await r.json();
      document.getElementById('tx-status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: PENDING';
      alert(data.message || JSON.stringify(data));
      // start watching credits and transaction status
      const before = parseInt(document.getElementById('credits').textContent || '0', 10);
      startCreditWatcher(before);
    }

    async function getCredits(){
      if (!token) return 0;
      const r = await fetch(API + '/user/credits', { headers: { ...auth() } });
      const data = await r.json();
      return parseInt(data.credit_balance || 0, 10);
    }
    async function loadCredits() {
      if (!token) return;
      const balance = await getCredits();
      document.getElementById('credits').textContent = balance;
      if (balance > 0) {
        if (!document.getElementById('source').options.length) await loadSources();
      }
    }

    function renderTemples(sources){
      const list = document.getElementById('temples');
      list.innerHTML = '';
      // ensure at least 4 plaques (fill with coming soon)
      const items = [...sources];
      while(items.length < 4){
        items.push({ id: 0, name: '‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ', type: 'ComingSoon' });
      }
      items.slice(0,4).forEach(s=>{
        const isSoon = s.type === 'ComingSoon';
        const icon = s.type === 'Tarot' ? 'üé¥' : 'üõï';
        const div = document.createElement('div');
        div.className = 'plaque';
        div.innerHTML = `
          <div class="edges">
            <div class="edge left"></div>
            <div class="edge right"></div>
          </div>
          <div class="temple-card">
            <div class="temple-icon">${icon}</div>
            <div>
              <h3 class="plaque-title">${s.name}</h3>
              ${isSoon
                ? `<span class="btn-soon">‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ</span>`
                : `<button class="btn-gold" data-id="${s.id}">‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏±‡∏î</button>`
              }
            </div>
          </div>
        `;
        if (!isSoon) {
          div.querySelector('button').addEventListener('click', ()=> enterTemple(s.id));
        }
        list.appendChild(div);
      });
    }
    async function loadSources() {
      const r = await fetch(API + '/fortune/sources');
      const data = await r.json();
      const el = document.getElementById('source');
      el.innerHTML = '';
      data.forEach(s => {
        const op = document.createElement('option');
        op.value = s.id; op.textContent = `${s.name} (${s.type})`;
        el.appendChild(op);
      });
      renderTemples(data);
    }

    function enterTemple(id){
      selectedSourceId = id;
      if (!token) {
        setStep(1);
      } else {
        showFlow();
        // make sure dropdown has this source selected
        ensureSelectSource();
        setStep(4);
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function draw() {
      const credits = parseInt(document.getElementById('credits').textContent || '0', 10);
      if (!credits || credits<=0) return alert('‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô');
      const source_id = parseInt(document.getElementById('source').value, 10);
      const r = await fetch(API + '/fortune/draw', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...auth() },
        body: JSON.stringify({ source_id })
      });
      const data = await r.json();
      if (data.error) return alert(data.error);
      document.getElementById('result-key').textContent = data.result_key;
      document.getElementById('verse').textContent = data.verse_content || '';
      document.getElementById('summary').textContent = data.fate_summary || '-';
      document.getElementById('balance').textContent = data.new_credit_balance;
      document.getElementById('drawn').classList.remove('hidden');
      await loadCredits();
      setStep(5);
      await loadHistory();
    }

    async function loadHistory() {
      const r = await fetch(API + '/user/history/all', { headers: { ...auth() } });
      const data = await r.json();
      document.getElementById('history').textContent = JSON.stringify(data, null, 2);
    }

    let creditWatchTimer = null;
    async function updateTxStatus(){
      if (!currentTx) return;
      try {
        const r = await fetch(API + '/payment/status/' + encodeURIComponent(currentTx), { headers: { ...auth() }});
        if (r.ok) {
          const data = await r.json();
          document.getElementById('tx-status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + (data.status || '-');
        }
      } catch(_){}
    }
    async function startCreditWatcher(before){
      if (creditWatchTimer) clearInterval(creditWatchTimer);
      creditWatchTimer = setInterval(async ()=>{
        await updateTxStatus();
        const now = await getCredits();
        document.getElementById('credits').textContent = now;
        if (now > before) {
          clearInterval(creditWatchTimer);
          creditWatchTimer = null;
          alert('‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
          setStep(4);
        }
      }, 3000);
    }

    // init
    // clickable steps with gating
    document.addEventListener('keydown', (e)=>{
      if (e.altKey && e.shiftKey && e.key.toLowerCase() === 'a') {
        location.href = 'admin/index.html';
      }
    });
    document.querySelectorAll('#progress .step').forEach(s=>{
      s.addEventListener('click', ()=>{
        const n = parseInt(s.dataset.step,10);
        setStep(n);
      });
    });

    // do not open flow automatically; keep landing with temple plaques
    if (token) {
      document.getElementById('me').classList.remove('hidden');
      document.getElementById('me-guest').classList.add('hidden');
      document.getElementById('me-id').textContent = userId;
    }

    loadPackages();
    loadSources();
    if (token) loadCredits();
  </script>
</body>
</html>