<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fortune - ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ / ‡πÑ‡∏û‡πà‡∏¢‡∏¥‡∏õ‡∏ã‡∏µ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Prompt", system-ui, -apple-system, sans-serif; margin: 0; padding: 0; background: #0f1020; color: #f4f6fb; }
    .container { max-width: 920px; margin: 0 auto; padding: 24px; }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .brand { font-size: 20px; font-weight: 600; }
    .card { background: #17182f; border: 1px solid #2b2c4a; border-radius: 12px; padding: 16px; margin: 12px 0; }
    input, select, button, textarea { background: #0b0d1a; border: 1px solid #2b2c4a; color: #fff; border-radius: 8px; padding: 10px 12px; outline: none; }
    button { cursor: pointer; transition: all .2s; }
    button.primary { background: #5a59ff; border-color: #5a59ff; }
    button.primary:hover { filter: brightness(1.1); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; }
    .qr { background: #0b0d1a; border-radius: 8px; display: inline-block; padding: 10px; }
    .muted { color: #a1a6c3; }
    .hidden { display: none; }
    nav a { color: #a1a6c3; margin-right: 12px; text-decoration: none; }
    nav a.active { color: #fff; font-weight: 600; }
    .footer { opacity: 0.6; font-size: 13px; margin-top: 32px; }
    .pkg { display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px dashed #2b2c4a; border-radius: 8px; }
    .best { color: #ffbd59; font-weight: 600; margin-left: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">üîÆ Fortune</div>
      <nav>
        <a href="#" id="tab-home" class="active">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        <a href="#" id="tab-fortune">‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</a>
        <a href="admin.html">Admin</a>
      </nav>
    </header>

    <div id="home" class="card">
      <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
      <div class="row">
        <div>
          <h3 class="muted">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
          <input id="reg-email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" />
          <input id="reg-pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
          <button class="primary" onclick="register()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
        </div>
        <div>
          <h3 class="muted">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
          <input id="login-email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" />
          <input id="login-pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
          <button class="primary" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤</button>
        </div>
      </div>
      <div id="me" class="hidden">
        <p>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß: <span id="me-id"></span></p>
        <button onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>

    <div class="card">
      <h2>‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</h2>
      <div id="packages" class="grid"></div>
    </div>

    <div id="payment" class="card hidden">
      <h2>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô PromptPay</h2>
      <p class="muted">‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
      <div id="qr" class="qr"></div>
      <div><small class="muted">payload: <code id="qr-payload"></code></small></div>
      <div style="margin-top:10px">
        <input id="slip-url" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á URL)" style="width: 100%;" />
        <button class="primary" onclick="verify()">‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
      </div>
    </div>

    <div id="fortune" class="card hidden">
      <h2>‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</h2>
      <div>
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</label>
        <select id="source"></select>
      </div>
      <div style="margin-top:8px">
        <button class="primary" onclick="draw()">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢ 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
      </div>
      <div id="drawn" class="hidden" style="margin-top:12px">
        <h3 id="result-key"></h3>
        <p id="verse"></p>
        <p><b>‡∏™‡∏£‡∏∏‡∏õ:</b> <span id="summary"></span></p>
        <p>‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="balance"></span></p>
      </div>
    </div>

    <div class="card">
      <h2>‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
      <p><span id="credits">-</span></p>
      <button onclick="loadCredits()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</button>
      <button onclick="loadHistory()">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
      <pre id="history" class="muted"></pre>
    </div>

    <div class="footer">¬© Fortune Demo. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
  </div>

  <script src="config.js"></script>
  <script>
    const API = window.APP_CONFIG.API_BASE;
    let token = localStorage.getItem('token') || '';
    let userId = localStorage.getItem('user_id') || '';
    const auth = () => token ? { 'Authorization': 'Bearer ' + token } : {};

    function setLoggedIn(id, tok) {
      userId = id; token = tok;
      localStorage.setItem('user_id', id);
      localStorage.setItem('token', tok);
      document.getElementById('me').classList.remove('hidden');
      document.getElementById('me-id').textContent = id;
      loadCredits();
      loadPackages();
      loadSources();
    }

    async function register() {
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-pass').value;
      const r = await fetch(API + '/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
      const data = await r.json();
      if (r.ok) setLoggedIn(data.user_id, data.token); else alert(JSON.stringify(data));
    }
    async function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-pass').value;
      const r = await fetch(API + '/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
      const data = await r.json();
      if (r.ok) setLoggedIn(data.user_id, data.token); else alert(JSON.stringify(data));
    }
    function logout() {
      localStorage.removeItem('user_id'); localStorage.removeItem('token');
      token=''; userId='';
      document.getElementById('me').classList.add('hidden');
    }

    async function loadPackages() {
      const r = await fetch(API + '/packages');
      const data = await r.json();
      const el = document.getElementById('packages');
      el.innerHTML = '';
      data.forEach(pkg => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="pkg">
            <div><b>${pkg.name}</b> <span class="muted">(${pkg.credits} ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)</span> ${pkg.is_best_seller ? '<span class="best">Best Seller</span>' : ''}</div>
            <div><b>${pkg.price.toFixed(2)}</b> ‡∏ö‡∏≤‡∏ó</div>
          </div>
          <button class="primary" ${!token ? 'disabled' : ''} onclick="buy(${pkg.id})">‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏ô‡∏µ‡πâ</button>
        `;
        el.appendChild(div);
      });
    }

    let currentTx = null;
    async function buy(package_id) {
      const r = await fetch(API + '/payment/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...auth() },
        body: JSON.stringify({ package_id })
      });
      const data = await r.json();
      if (!r.ok) return alert(JSON.stringify(data));
      currentTx = data.transaction_id;
      document.getElementById('qr').innerHTML = `<img src="${data.qr_code_url}" width="200" height="200" />`;
      document.getElementById('qr-payload').textContent = data.qr_payload;
      document.getElementById('payment').classList.remove('hidden');
    }

    async function verify() {
      const slip = document.getElementById('slip-url').value;
      if (!currentTx) return;
      const r = await fetch(API + '/payment/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...auth() },
        body: JSON.stringify({ transaction_id: currentTx, slip_image_url: slip })
      });
      const data = await r.json();
      alert(data.message || JSON.stringify(data));
    }

    async function loadCredits() {
      if (!token) return;
      const r = await fetch(API + '/user/credits', { headers: { ...auth() } });
      const data = await r.json();
      document.getElementById('credits').textContent = data.credit_balance;
    }

    async function loadSources() {
      const r = await fetch(API + '/fortune/sources');
      const data = await r.json();
      const el = document.getElementById('source');
      el.innerHTML = '';
      data.forEach(s => {
        const op = document.createElement('option');
        op.value = s.id; op.textContent = `${s.name} (${s.type})`;
        el.appendChild(op);
      });
    }

    async function draw() {
      const source_id = parseInt(document.getElementById('source').value, 10);
      const r = await fetch(API + '/fortune/draw', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...auth() },
        body: JSON.stringify({ source_id })
      });
      const data = await r.json();
      if (data.error) return alert(data.error);
      document.getElementById('result-key').textContent = data.result_key;
      document.getElementById('verse').textContent = data.verse_content || '';
      document.getElementById('summary').textContent = data.fate_summary || '-';
      document.getElementById('balance').textContent = data.new_credit_balance;
      document.getElementById('drawn').classList.remove('hidden');
      loadCredits();
    }

    async function loadHistory() {
      const r = await fetch(API + '/user/history/all', { headers: { ...auth() } });
      const data = await r.json();
      document.getElementById('history').textContent = JSON.stringify(data, null, 2);
    }

    // tabs
    document.getElementById('tab-home').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('home').classList.remove('hidden'); document.getElementById('fortune').classList.add('hidden'); document.getElementById('tab-home').classList.add('active'); document.getElementById('tab-fortune').classList.remove('active'); });
    document.getElementById('tab-fortune').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('home').classList.add('hidden'); document.getElementById('fortune').classList.remove('hidden'); document.getElementById('tab-home').classList.remove('active'); document.getElementById('tab-fortune').classList.add('active'); });

    // init
    if (token) {
      document.getElementById('me').classList.remove('hidden');
      document.getElementById('me-id').textContent = userId;
    }
    loadPackages();
    loadSources();
    if (token) loadCredits();
  </script>
</body>
</html>