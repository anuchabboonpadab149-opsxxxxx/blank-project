<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fortune - ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">üîÆ Fortune</div>
      <nav>
        <a href="#" id="menu-help">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</a>
      </nav>
    </header>

    <div class="hero card">
      <div class="badge">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤ ‚Ä¢ ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ ‚Ä¢ ‡πÑ‡∏û‡πà‡∏¢‡∏¥‡∏õ‡∏ã‡∏µ</div>
      <h2>‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h2>
      <p class="muted">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à ‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
    </div>

    <section id="temples" class="temple-list">
      <!-- dynamically rendered temple plaques -->
    </section>

    <div id="flow" class="hidden">
      <div id="progress" class="stepper">
        <div class="step" data-step="1"><div class="dot">1</div><div class="label">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div></div>
        <div class="step" data-step="2"><div class="dot">2</div><div class="label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</div></div>
        <div class="step" data-step="3"><div class="dot">3</div><div class="label">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div></div>
        <div class="step" data-step="4"><div class="dot">4</div><div class="label">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢</div></div>
        <div class="step" data-step="5"><div class="dot">5</div><div class="label">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div></div>
      </div>

    <!-- STEP 1 -->
    <section id="step-1" class="card split">
      <div>
        <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <div class="row">
          <div>
            <h4 class="muted">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h4>
            <input id="reg-email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" />
            <input id="reg-pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
            <button class="primary" onclick="register()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
          </div>
          <div>
            <h4 class="muted">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h4>
            <input id="login-email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" />
            <input id="login-pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
            <button class="primary" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤</button>
          </div>
        </div>
      </div>
      <aside class="card">
        <div id="me" class="hidden">
          <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="badge">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span></p>
          <p class="muted">User ID: <span id="me-id"></span></p>
          <button class="ghost" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        <div id="me-guest">
          <p class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>
      </aside>
    </section>

    <!-- STEP 2 -->
    <section id="step-2" class="card">
      <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</h3>
      <p class="muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‚Äú‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‚Äù</p>
      <div id="packages" class="grid"></div>
    </section>

    <!-- STEP 3 -->
    <section id="step-3" class="card hidden">
      <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô PromptPay</h3>
      <p class="muted">‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
      <div class="row">
        <div>
          <div id="qr" class="qr"></div>
          <div style="margin-top:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="badge" id="tx-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: -</span>
          </div>
        </div>
        <div>
          <input id="slip-url" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á URL)" style="width: 100%;" />
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="primary" onclick="verify()">‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
            <button class="ghost" onclick="loadCredits()">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
          </div>
          <p class="muted" style="margin-top:6px">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
        </div>
      </div>
    </section>

    <!-- STEP 4 -->
    <section id="step-4" class="card hidden">
      <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 4: ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</h3>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <span class="badge">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b id="credits">-</b></span>
        <button class="ghost" onclick="loadCredits()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</button>
      </div>

      <div class="tabs">
        <div id="tab-sensi" class="tab active">‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ</div>
        <div id="tab-tarot" class="tab">‡πÑ‡∏û‡πà‡∏¢‡∏¥‡∏õ‡∏ã‡∏µ</div>
      </div>

      <!-- hidden dropdown just to preserve logic; not shown -->
      <div style="display:none">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</label>
        <select id="source"></select>
      </div>

      <!-- Sen-Si panel -->
      <div id="panel-sensi">
        <div style="margin-top:8px">
          <button class="primary" onclick="draw()">‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ (‡πÉ‡∏ä‡πâ 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)</button>
        </div>
        <div id="drawn" class="hidden" style="margin-top:10px">
          <h4 id="result-key"></h4>
          <p id="verse"></p>
          <p><b>‡∏™‡∏£‡∏∏‡∏õ:</b> <span id="summary"></span></p>
          <p class="muted">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢: <b id="balance"></b></p>
        </div>
      </div>

      <!-- Tarot panel -->
      <div id="panel-tarot" class="hidden">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 6px">
          <button class="primary" onclick="drawTarot(5)">‡∏î‡∏π 5 ‡πÉ‡∏ö (‡πÉ‡∏ä‡πâ 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)</button>
          <button class="primary" onclick="drawTarot(10)">‡∏î‡∏π 10 ‡πÉ‡∏ö (‡πÉ‡∏ä‡πâ 2 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)</button>
        </div>
        <div id="tarot-result" class="tarot-grid"></div>
        <div id="tarot-balance" class="muted" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- STEP 5 -->
    <section id="step-5" class="card hidden">
      <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 5: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠/‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="ghost" onclick="loadHistory()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
      </div>
      <pre id="history" class="muted" style="margin-top:10px"></pre>
    </section>
    </div>

    <div class="footer">¬© Fortune. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</div>
  </div>

  <script src="config.js"></script>
  <script>
    const API = window.APP_CONFIG.API_BASE;
    let token = localStorage.getItem('token') || '';
    let userId = localStorage.getItem('user_id') || '';
    let currentTx = null;
    let selectedSourceId = null;
    let sourcesList = [];
    let tarotSourceId = null;
    let senSiSourceId = null;

    // DEMO fallback (when backend isn‚Äôt connected yet)
    const DEMO_GATEWAY = API.includes('gateway-production.example');
    let DEMO = DEMO_GATEWAY;
    function enableDemo(){ DEMO = true; console.warn('[DEMO] Enabled'); }
    const DEMO_KEYS = {
      credits: 'demo_credits',
      history: 'demo_history',
      tx: 'demo_tx_map'
    };
    function demoGet(key, def){ try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); } catch(_){ return def; } }
    function demoSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    function demoInit(){
      if (localStorage.getItem(DEMO_KEYS.credits) == null) demoSet(DEMO_KEYS.credits, 0);
      if (localStorage.getItem(DEMO_KEYS.history) == null) demoSet(DEMO_KEYS.history, { buy_history: [], fortune_history: [] });
      if (localStorage.getItem(DEMO_KEYS.tx) == null) demoSet(DEMO_KEYS.tx, {});
    }
    if (DEMO) demoInit();

    const auth = () => token ? { 'Authorization': 'Bearer ' + token } : {};
    function showFlow(){ document.getElementById('flow').classList.remove('hidden'); }
    function getSourceById(id){
      return (sourcesList || []).find(s => s.id === id) || null;
    }

    function goto(step){
      // show panel
      for (let i=1;i<=5;i++){
        const sec = document.getElementById('step-'+i);
        if (!sec) continue;
        if (i === step) sec.classList.remove('hidden'); else sec.classList.add('hidden');
      }
      // update stepper
      const steps = document.querySelectorAll('#progress .step');
      steps.forEach(s => {
        const n = parseInt(s.dataset.step,10);
        s.classList.remove('active','done');
        if (n === step) s.classList.add('active');
        else if (n < step) s.classList.add('done');
      });
    }
    function canGo(step){
      // gate conditions
      if (step>=2 && !token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return false; }
      return true;
    }
    function setStep(step){
      if (!canGo(step)) return;
      showFlow();
      goto(step);
      if (step === 4){
        const src = selectedSourceId ? getSourceById(selectedSourceId) : null;
        if (src && src.type === 'Tarot'){
          activateTab('tarot');
        } else {
          activateTab('sensi');
        }
      }
    }

    function ensureSelectSource(){
      if (selectedSourceId) {
        const el = document.getElementById('source');
        const opt = [...el.options].find(o => parseInt(o.value,10) === selectedSourceId);
        if (opt) el.value = String(selectedSourceId);
      }
    }
    function setLoggedIn(id, tok) {
      userId = id; token = tok;
      localStorage.setItem('user_id', id);
      localStorage.setItem('token', tok);
      document.getElementById('me').classList.remove('hidden');
      document.getElementById('me-guest').classList.add('hidden');
      document.getElementById('me-id').textContent = id;
      loadCredits();
      loadPackages();
      loadSources().then(()=>{
        ensureSelectSource();
        // go to step 2 (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à) ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠
        setStep(2);
      });
    }

    async function register() {
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-pass').value;
      if (!email || !password) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
      try{
        const r = await fetch(API + '/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
        const data = await r.json();
        if (r.ok) setLoggedIn(data.user_id, data.token);
        else { throw new Error(JSON.stringify(data)); }
      } catch(e){
        enableDemo(); demoInit();
        setLoggedIn('demo-user', 'demo-token');
      }
    }
    async function login() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-pass').value;
      if (!email || !password) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
      try{
        const r = await fetch(API + '/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
        const data = await r.json();
        if (r.ok) setLoggedIn(data.user_id, data.token);
        else { throw new Error(JSON.stringify(data)); }
      } catch(e){
        enableDemo(); demoInit();
        setLoggedIn('demo-user', 'demo-token');
      }
    }
    function logout() {
      localStorage.removeItem('user_id'); localStorage.removeItem('token');
      token=''; userId='';
      currentTx=null;
      document.getElementById('me').classList.add('hidden');
      document.getElementById('me-guest').classList.remove('hidden');
      setStep(1);
    }

    async function loadPackages() {
      const el = document.getElementById('packages');
      el.innerHTML = '';
      try{
        const r = await fetch(API + '/packages');
        if (!r.ok) throw new Error('packages not ok');
        const data = await r.json();
        data.forEach(pkg => {
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <div class="pkg">
              <div><b>${pkg.name}</b> <span class="muted">(${pkg.credits} ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)</span> ${pkg.is_best_seller ? '<span class="best">Best Seller</span>' : ''}</div>
              <div><b>${pkg.price.toFixed(2)}</b> ‡∏ö‡∏≤‡∏ó</div>
            </div>
            <button class="primary" ${!token ? 'disabled' : ''} onclick="buy(${pkg.id})">‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏ô‡∏µ‡πâ</button>
          `;
          el.appendChild(div);
        });
      } catch(e){
        // DEMO fallback
        enableDemo(); demoInit();
        const demoPkgs = [
          { id: 1, name: '‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å', price: 29.0, credits: 1, is_best_seller: false },
          { id: 2, name: '‡πÅ‡∏û‡πá‡∏Å‡∏Å‡∏•‡∏≤‡∏á', price: 79.0, credits: 3, is_best_seller: true },
          { id: 3, name: '‡πÅ‡∏û‡πá‡∏Å‡πÉ‡∏´‡∏ç‡πà', price: 199.0, credits: 10, is_best_seller: false },
        ];
        demoPkgs.forEach(pkg=>{
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <div class="pkg">
              <div><b>${pkg.name}</b> <span class="muted">(${pkg.credits} ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)</span> ${pkg.is_best_seller ? '<span class="best">Best Seller</span>' : ''}</div>
              <div><b>${pkg.price.toFixed(2)}</b> ‡∏ö‡∏≤‡∏ó</div>
            </div>
            <button class="primary" ${!token ? 'disabled' : ''} onclick="buy(${pkg.id})">‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏ô‡∏µ‡πâ</button>
          `;
          el.appendChild(div);
        });
      }
    }

    async function buy(package_id) {
      if (!token) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
      if (DEMO) {
        const tx = 'demo-' + Math.random().toString(36).slice(2,10);
        currentTx = tx;
        // sample QR (placeholder)
        document.getElementById('qr').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=DEMO-${tx}" width="220" height="220" />`;
        document.getElementById('tx-status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: CREATED';
        setStep(3);
        // save demo buy history
        const hist = demoGet(DEMO_KEYS.history, {buy_history:[], fortune_history:[]});
        hist.buy_history.push({ transaction_id: tx, package_id, amount: 0, status: 'CREATED', created_at: new Date().toISOString() });
        demoSet(DEMO_KEYS.history, hist);
        const txmap = demoGet(DEMO_KEYS.tx, {});
        txmap[tx] = { status: 'CREATED' };
        demoSet(DEMO_KEYS.tx, txmap);
        return;
      }
      const r = await fetch(API + '/payment/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...auth() },
        body: JSON.stringify({ package_id })
      });
      const data = await r.json();
      if (!r.ok) return alert(JSON.stringify(data));
      currentTx = data.transaction_id;
      document.getElementById('qr').innerHTML = `<img src="${data.qr_code_url}" width="220" height="220" />`;
      document.getElementById('tx-status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: CREATED';
      setStep(3);
    }

    async function verify() {
      const slip = document.getElementById('slip-url').value.trim();
      if (!currentTx) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠');
      if (!slip) return alert('‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
      if (DEMO) {
        document.getElementById('tx-status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: PENDING';
        alert('DEMO: ‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ');
        const before = parseInt(document.getElementById('credits').textContent || '0', 10);
        // simulate confirm in 6s and add 3 credits
        setTimeout(()=>{
          const txmap = demoGet(DEMO_KEYS.tx, {});
          if (txmap[currentTx]) txmap[currentTx].status = 'CONFIRMED';
          demoSet(DEMO_KEYS.tx, txmap);
          const c = demoGet(DEMO_KEYS.credits, 0) + 3;
          demoSet(DEMO_KEYS.credits, c);
        }, 6000);
        startCreditWatcher(before);
        return;
      }
      const r = await fetch(API + '/payment/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...auth() },
        body: JSON.stringify({ transaction_id: currentTx, slip_image_url: slip })
      });
      const data = await r.json();
      document.getElementById('tx-status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: PENDING';
      alert(data.message || JSON.stringify(data));
      // start watching credits and transaction status
      const before = parseInt(document.getElementById('credits').textContent || '0', 10);
      startCreditWatcher(before);
    }

    async function getCredits(){
      if (!token) return 0;
      if (DEMO) return demoGet(DEMO_KEYS.credits, 0);
      const r = await fetch(API + '/user/credits', { headers: { ...auth() } });
      const data = await r.json();
      return parseInt(data.credit_balance || 0, 10);
    }
    async function loadCredits() {
      if (!token) return;
      const balance = await getCredits();
      document.getElementById('credits').textContent = balance;
      if (balance > 0) {
        if (!document.getElementById('source').options.length) await loadSources();
      }
    }

    function renderTemplesActive() {
      // Always show 4 active plaques (map to available sources; duplicate ids if necessary)
      const list = document.getElementById('temples');
      list.innerHTML = '';
      const sen = senSiSourceId || (sourcesList.find(s=>s.type==='Sen_Si')||{}).id || selectedSourceId;
      const tar = tarotSourceId || (sourcesList.find(s=>s.type==='Tarot')||{}).id || selectedSourceId;
      const items = [
        { id: sen || 1, name: '‡∏ß‡∏±‡∏î‡πÄ‡∏ó‡∏û‡∏û‡∏£‡∏∞‡πÅ‡∏°‡πà‡∏≠‡∏∏‡∏©‡∏≤‡∏°‡∏≤‡πÄ‡∏ó‡∏ß‡∏µ', type: 'Sen_Si' },
        { id: sen || 1, name: '‡∏ß‡∏±‡∏î‡∏´‡∏•‡∏ß‡∏á‡∏û‡πà‡∏≠‡∏û‡∏±‡∏í‡∏ô‡πå', type: 'Sen_Si' },
        { id: sen || 1, name: '‡∏ß‡∏±‡∏î‡πÇ‡∏û‡∏ò‡∏¥‡πå‡∏ä‡∏±‡∏¢ ‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢ ‡∏´‡∏•‡∏ß‡∏á‡∏û‡πà‡∏≠‡∏û‡∏£‡∏∞‡πÉ‡∏™', type: 'Sen_Si' },
        { id: tar || 99, name: '‡∏î‡∏π‡πÑ‡∏û‡πà‡∏¢‡∏¥‡∏õ‡∏ã‡∏µ (5/10 ‡πÉ‡∏ö)', type: 'Tarot' },
      ];
      items.forEach(s=>{
        const icon = s.type === 'Tarot' ? 'üé¥' : 'üõï';
        const div = document.createElement('div');
        div.className = 'plaque';
        div.innerHTML = `
          <div class="edges">
            <div class="edge left"></div>
            <div class="edge right"></div>
          </div>
          <div class="temple-card">
            <div class="temple-icon">${icon}</div>
            <div>
              <h3 class="plaque-title">${s.name}</h3>
              <button class="btn-gold" data-id="${s.id}">‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏±‡∏î</button>
            </div>
          </div>
        `;
        div.querySelector('button').addEventListener('click', ()=> enterTemple(s.id));
        list.appendChild(div);
      });
    }
    async function loadSources() {
      try{
        const r = await fetch(API + '/fortune/sources');
        if (!r.ok) throw new Error('sources not ok');
        const data = await r.json();
        sourcesList = data || [];
        tarotSourceId = (sourcesList.find(s=>s.type==='Tarot')||{}).id || null;
        senSiSourceId = (sourcesList.find(s=>s.type==='Sen_Si')||{}).id || null;
        const el = document.getElementById('source');
        el.innerHTML = '';
        (data||[]).forEach(s => {
          const op = document.createElement('option');
          op.value = s.id; op.textContent = `${s.name} (${s.type})`;
          el.appendChild(op);
        });
        renderTemplesActive();
      } catch(e){
        enableDemo(); demoInit();
        // DEMO local sources
        sourcesList = [
          { id: 1, name:'‡∏ß‡∏±‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ)', type:'Sen_Si' },
          { id: 99, name:'‡πÑ‡∏û‡πà‡∏¢‡∏¥‡∏õ‡∏ã‡∏µ (‡∏à‡∏≥‡∏•‡∏≠‡∏á)', type:'Tarot' },
        ];
        tarotSourceId = 99; senSiSourceId = 1;
        const el = document.getElementById('source');
        el.innerHTML = '';
        sourcesList.forEach(s=>{
          const op = document.createElement('option');
          op.value = s.id; op.textContent = `${s.name} (${s.type})`;
          el.appendChild(op);
        });
        renderTemplesActive();
      }
    }

    function enterTemple(id){
      selectedSourceId = id;
      // set tab based on selected source type
      const src = (sourcesList||[]).find(s=>s.id===id);
      if (src && src.type === 'Tarot'){
        tarotSourceId = id;
        activateTab('tarot');
      } else {
        activateTab('sensi');
      }
      if (!token) {
        setStep(1);
      } else {
        showFlow();
        ensureSelectSource();
        // ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏±‡∏î ‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠
        setStep(2);
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function draw() {
      const credits = parseInt(document.getElementById('credits').textContent || '0', 10);
      if (!credits || credits<=0) return alert('‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô');
      const srcId = selectedSourceId || parseInt(document.getElementById('source').value, 10);
      if (DEMO){
        const c = demoGet(DEMO_KEYS.credits, 0);
        if (c <= 0) return alert('‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏û‡∏≠');
        demoSet(DEMO_KEYS.credits, c-1);
        const n = Math.floor(Math.random()*100)+1;
        const resKey = `‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ ‡πÉ‡∏ö‡∏ó‡∏µ‡πà ${n}`;
        const verse = `‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÉ‡∏ö‡∏ó‡∏µ‡πà ${n} ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ ‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†`;
        const hist = demoGet(DEMO_KEYS.history, {buy_history:[], fortune_history:[]});
        const id = 'f-'+Date.now();
        hist.fortune_history.push({ id, source_id: srcId, source_type: 'Sen_Si', result_key: resKey, reading_date: new Date().toISOString(), verse_content: verse, fate_summary: '‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ' });
        demoSet(DEMO_KEYS.history, hist);
        document.getElementById('result-key').textContent = resKey;
        document.getElementById('verse').textContent = verse;
        document.getElementById('summary').textContent = '‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ';
        document.getElementById('balance').textContent = c-1;
        document.getElementById('drawn').classList.remove('hidden');
        await loadCredits();
        setStep(5);
        await loadHistory();
        return;
      }
      const r = await fetch(API + '/fortune/draw', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...auth() },
        body: JSON.stringify({ source_id: srcId })
      });
      const data = await r.json();
      if (data.error) return alert(data.error);
      document.getElementById('result-key').textContent = data.result_key;
      document.getElementById('verse').textContent = data.verse_content || '';
      document.getElementById('summary').textContent = data.fate_summary || '-';
      document.getElementById('balance').textContent = data.new_credit_balance;
      document.getElementById('drawn').classList.remove('hidden');
      await loadCredits();
      setStep(5);
      await loadHistory();
    }

    async function drawTarot(count){
      if (!tarotSourceId && !DEMO) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏´‡∏•‡πà‡∏á‡πÑ‡∏û‡πà‡∏¢‡∏¥‡∏õ‡∏ã‡∏µ');
      const credits = parseInt(document.getElementById('credits').textContent || '0', 10);
      const cost = count === 10 ? 2 : 1;
      if (credits < cost) return alert('‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏û‡∏≠');

      if (DEMO){
        const cardsList = ['The Fool','The Magician','The High Priestess','The Empress','The Emperor','The Hierophant','The Lovers','The Chariot','Strength','The Hermit'];
        const n = count;
        const chosen = [];
        for (let i=0;i<n;i++){
          const name = cardsList[Math.floor(Math.random()*cardsList.length)];
          const up = Math.random()<0.5;
          chosen.push({ name, orientation: up?'Upright':'Reversed', meaning: up?'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å':'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ä‡∏¥‡∏á‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢' });
        }
        const grid = document.getElementById('tarot-result');
        grid.innerHTML = '';
        chosen.forEach(c=>{
          const el = document.createElement('div');
          el.className = 'tarot-card';
          el.innerHTML = `<h5>${c.name} (${c.orientation})</h5><div class="muted">${c.meaning}</div>`;
          grid.appendChild(el);
        });
        const c = demoGet(DEMO_KEYS.credits, 0) - cost;
        demoSet(DEMO_KEYS.credits, c);
        document.getElementById('tarot-balance').textContent = '‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ' + c;
        // push history
        const hist = demoGet(DEMO_KEYS.history, {buy_history:[], fortune_history:[]});
        const id = 't-'+Date.now();
        hist.fortune_history.push({ id, source_id: (tarotSourceId||99), source_type:'Tarot', result_key:`Tarot x${n}`, reading_date:new Date().toISOString(), verse_content: chosen.map(x=>`${x.name} (${x.orientation})`).join(', '), fate_summary: null });
        demoSet(DEMO_KEYS.history, hist);
        await loadCredits();
        setStep(5);
        await loadHistory();
        return;
      }

      const r = await fetch(API + '/fortune/tarot/draw-multi', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...auth() },
        body: JSON.stringify({ source_id: tarotSourceId, count })
      });
      if (!r.ok) {
        const err = await r.text();
        return alert(err || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÑ‡∏î‡πâ');
      }
      const data = await r.json();
      const grid = document.getElementById('tarot-result');
      grid.innerHTML = '';
      (data.cards||[]).forEach(c=>{
        const el = document.createElement('div');
        el.className = 'tarot-card';
        el.innerHTML = `<h5>${c.name} (${c.orientation})</h5><div class="muted">${c.meaning}</div>`;
        grid.appendChild(el);
      });
      document.getElementById('tarot-balance').textContent = '‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ' + data.new_credit_balance;
      await loadCredits();
      setStep(5);
      await loadHistory();
    }

    async function loadHistory() {
      if (DEMO){
        document.getElementById('history').textContent = JSON.stringify(demoGet(DEMO_KEYS.history, {buy_history:[], fortune_history:[]}), null, 2);
        return;
      }
      const r = await fetch(API + '/user/history/all', { headers: { ...auth() } });
      const data = await r.json();
      document.getElementById('history').textContent = JSON.stringify(data, null, 2);
    }

    let creditWatchTimer = null;
    async function updateTxStatus(){
      if (!currentTx) return;
      if (DEMO){
        const txmap = demoGet(DEMO_KEYS.tx, {});
        const st = (txmap[currentTx]||{}).status || 'CREATED';
        document.getElementById('tx-status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + st;
        return;
      }
      try {
        const r = await fetch(API + '/payment/status/' + encodeURIComponent(currentTx), { headers: { ...auth() }});
        if (r.ok) {
          const data = await r.json();
          document.getElementById('tx-status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + (data.status || '-');
        }
      } catch(_){}
    }
    async function startCreditWatcher(before){
      if (creditWatchTimer) clearInterval(creditWatchTimer);
      creditWatchTimer = setInterval(async ()=>{
        await updateTxStatus();
        const now = await getCredits();
        document.getElementById('credits').textContent = now;
        if (now > before) {
          clearInterval(creditWatchTimer);
          creditWatchTimer = null;
          alert('‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
          setStep(4);
        }
      }, 3000);
    }

    // init
    // clickable steps with gating
    document.addEventListener('keydown', (e)=>{
      if (e.altKey && e.shiftKey && e.key.toLowerCase() === 'a') {
        location.href = 'admin/index.html';
      }
    });
    document.querySelectorAll('#progress .step').forEach(s=>{
      s.addEventListener('click', ()=>{
        const n = parseInt(s.dataset.step,10);
        setStep(n);
      });
    });

    // do not open flow automatically; keep landing with temple plaques
    if (token) {
      document.getElementById('me').classList.remove('hidden');
      document.getElementById('me-guest').classList.add('hidden');
      document.getElementById('me-id').textContent = userId;
    }

    // tabs switch
    function activateTab(which){
      const sensi = document.getElementById('panel-sensi');
      const tarot = document.getElementById('panel-tarot');
      const ts = document.getElementById('tab-sensi');
      const tt = document.getElementById('tab-tarot');
      if (which==='tarot'){
        sensi.classList.add('hidden'); tarot.classList.remove('hidden');
        ts.classList.remove('active'); tt.classList.add('active');
      } else {
        sensi.classList.remove('hidden'); tarot.classList.add('hidden');
        ts.classList.add('active'); tt.classList.remove('active');
      }
    }
    document.getElementById('tab-sensi').addEventListener('click', ()=> activateTab('sensi'));
    document.getElementById('tab-tarot').addEventListener('click', ()=> activateTab('tarot'));

    loadPackages();
    loadSources();
    if (token) loadCredits();
  </script>
</body>
</html>