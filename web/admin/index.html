<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">üõ†Ô∏è Admin Console</div>
      <nav>
        <a href="../index.html">‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (Public)</a>
      </nav>
    </header>

    <div class="hero card">
      <div class="badge">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö 3 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</div>
      <h2>‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô: ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</h2>
      <p class="muted">1) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Token  2) ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô  3) ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</p>
    </div>

    <div id="progress" class="stepper">
      <div class="step active" data-step="1"><div class="dot">1</div><div class="label">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Token</div></div>
      <div class="step" data-step="2"><div class="dot">2</div><div class="label">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div></div>
      <div class="step" data-step="3"><div class="dot">3</div><div class="label">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</div></div>
    </div>

    <!-- STEP 1 -->
    <section id="step-1" class="card split">
      <div>
        <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ADMIN_TOKEN</h3>
        <p class="muted">‡πÉ‡∏™‡πà Token ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</p>
        <input id="admin-token" placeholder="‡πÉ‡∏™‡πà ADMIN_TOKEN" />
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="primary" onclick="saveToken()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button class="ghost" onclick="clearToken()">‡∏•‡πâ‡∏≤‡∏á Token</button>
        </div>
      </div>
      <aside class="card">
        <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="status-token" class="badge">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span></p>
        <p class="muted">‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Deploy ‡πÅ‡∏ö‡∏ö Production ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö Token ‡πÉ‡∏ô Secret</p>
      </aside>
    </section>

    <!-- STEP 2 -->
    <section id="step-2" class="card hidden">
      <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
      <div class="row">
        <div>
          <input id="tx-id" placeholder="transaction_id" />
          <input id="user-id" placeholder="user_id" />
          <input id="credits" placeholder="credits_to_add (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏° package)" />
          <button class="primary" onclick="confirmPayment()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
        <div>
          <pre id="confirm-result" class="muted"></pre>
        </div>
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step-3" class="card hidden">
      <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</h3>
      <div class="row">
        <div class="card">
          <h4>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ (Source)</h4>
          <input id="src-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠" />
          <input id="src-type" placeholder="‡∏ä‡∏ô‡∏¥‡∏î (Sen_Si/Tarot)" />
          <input id="src-upright" placeholder="upright_prob ‡πÄ‡∏ä‡πà‡∏ô 0.7 (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Tarot)" />
          <input id="src-deck" placeholder="allowed_deck ‡πÄ‡∏ä‡πà‡∏ô Major ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ |" />
          <button class="primary" onclick="upsertSource()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
        <div class="card">
          <h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏µ</h4>
          <input id="sen-src" placeholder="source_id" />
          <input id="sen-num" placeholder="slip_number" />
          <textarea id="sen-verse" placeholder="verse_content"></textarea>
          <input id="sen-sum" placeholder="fate_summary" />
          <button class="primary" onclick="addSenSi()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
      </div>
      <div class="card">
        <h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡πÑ‡∏û‡πà‡∏¢‡∏¥‡∏õ‡∏ã‡∏µ</h4>
        <input id="tarot-name" placeholder="card_name" />
        <textarea id="tarot-up" placeholder="meaning_upright"></textarea>
        <textarea id="tarot-re" placeholder="meaning_reversed"></textarea>
        <button class="primary" onclick="addTarot()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      </div>
    </section>

    <div class="footer">¬© Fortune Admin. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô</div>
  </div>

  <script src="../config.js"></script>
  <script>
    const API = window.APP_CONFIG.API_BASE;

    function adminAuth() {
      const token = localStorage.getItem('admin_token') || window.APP_CONFIG.ADMIN_BEARER || '';
      return token ? { 'Authorization': 'Bearer ' + token } : {};
    }
    function hasToken(){ return !!(localStorage.getItem('admin_token') || window.APP_CONFIG.ADMIN_BEARER); }

    function goto(step){
      for (let i=1;i<=3;i++){
        const sec = document.getElementById('step-'+i);
        if (i===step) sec.classList.remove('hidden'); else sec.classList.add('hidden');
      }
      document.querySelectorAll('#progress .step').forEach(s=>{
        const n = parseInt(s.dataset.step,10);
        s.classList.remove('active','done');
        if (n===step) s.classList.add('active');
        else if (n<step) s.classList.add('done');
      });
    }
    function setStep(n){
      if (n>=2 && !hasToken()) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ADMIN_TOKEN ‡∏Å‡πà‡∏≠‡∏ô'); return; }
      goto(n);
    }

    function saveToken() {
      const t = document.getElementById('admin-token').value.trim();
      if (!t) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Token');
      localStorage.setItem('admin_token', t);
      document.getElementById('status-token').textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
      setStep(2);
    }
    function clearToken(){
      localStorage.removeItem('admin_token');
      document.getElementById('status-token').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤';
      setStep(1);
    }

    async function confirmPayment() {
      const tx = document.getElementById('tx-id').value.trim();
      const uid = document.getElementById('user-id').value.trim();
      const credits = document.getElementById('credits').value.trim();
      if (!tx || !uid) return alert('‡∏Å‡∏£‡∏≠‡∏Å transaction_id ‡πÅ‡∏•‡∏∞ user_id');
      const qs = new URLSearchParams({ transaction_id: tx, user_id: uid, credits_to_add: credits || ''}).toString();
      const r = await fetch(API + '/admin/payment/confirm?' + qs, { method: 'POST', headers: { ...adminAuth() }});
      const data = await r.json();
      document.getElementById('confirm-result').textContent = JSON.stringify(data, null, 2);
    }
    async function upsertSource() {
      const name = document.getElementById('src-name').value.trim();
      const type = document.getElementById('src-type').value.trim();
      const upright_prob = document.getElementById('src-upright').value.trim();
      const allowed_deck = document.getElementById('src-deck').value.trim();
      if (!name || !type) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î');
      const body = { name, type, upright_prob: upright_prob ? parseFloat(upright_prob) : null, allowed_deck: allowed_deck || null };
      const r = await fetch(API + '/admin/content/source', { method: 'POST', headers: { 'Content-Type': 'application/json', ...adminAuth() }, body: JSON.stringify(body)});
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß (' + r.status + ')');
    }
    async function addSenSi() {
      const source_id = parseInt(document.getElementById('sen-src').value, 10);
      const slip_number = parseInt(document.getElementById('sen-num').value, 10);
      const verse_content = document.getElementById('sen-verse').value.trim();
      const fate_summary = document.getElementById('sen-sum').value.trim();
      if (!source_id || !slip_number || !verse_content) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
      const r = await fetch(API + '/admin/content/sen-si', { method: 'POST', headers: { 'Content-Type': 'application/json', ...adminAuth() }, body: JSON.stringify({ source_id, slip_number, verse_content, fate_summary })});
      alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß (' + r.status + ')');
    }
    async function addTarot() {
      const card_name = document.getElementById('tarot-name').value.trim();
      const meaning_upright = document.getElementById('tarot-up').value.trim();
      const meaning_reversed = document.getElementById('tarot-re').value.trim();
      if (!card_name || !meaning_upright || !meaning_reversed) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
      const r = await fetch(API + '/admin/content/tarot', { method: 'POST', headers: { 'Content-Type': 'application/json', ...adminAuth() }, body: JSON.stringify({ card_name, meaning_upright, meaning_reversed })});
      alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß (' + r.status + ')');
    }

    // init
    document.querySelectorAll('#progress .step').forEach(s=>{
      s.addEventListener('click', ()=> setStep(parseInt(s.dataset.step,10)));
    });
    if (hasToken()) {
      document.getElementById('status-token').textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
      setStep(2);
    } else {
      setStep(1);
    }
  </script>
</body>
</html>