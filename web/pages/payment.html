<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‚Ä¢ Fortune</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="brand"><a href="../index.html" style="color:#fff;text-decoration:none">üîÆ Fortune</a></div>
      <nav>
        <a href="../pages/packages.html">‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</a>
        <a href="../pages/draw.html">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢</a>
        <a href="../pages/history.html">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a>
        <span id="nav-auth"><a href="../pages/login.html">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></span>
        <span id="nav-me" class="hidden">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <span id="me-id"></span> ¬∑ <a href="#" onclick="FT.logout()">‡∏≠‡∏≠‡∏Å</a></span>
      </nav>
    </header>

    <div class="card hero">
      <div class="badge">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3</div>
      <h2>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ PromptPay</h2>
      <p class="muted">‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
    </div>

    <section class="card">
      <div class="row">
        <div>
          <div id="qr" class="qr"></div>
          <div style="margin-top:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="badge" id="tx-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: -</span>
          </div>
        </div>
        <div>
          <input id="slip-url" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ (URL)" style="width: 100%;" />
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="primary" id="btn-verify">‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
            <button class="ghost" id="btn-refresh">‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
          </div>
          <p class="muted" style="margin-top:6px">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
        </div>
      </div>
    </section>

    <div class="footer">¬© Fortune</div>
  </div>

  <script src="../config.js"></script>
  <script src="../app.js"></script>
  <script>
    FT.attachAdminShortcut();
    FT.updateAuthUI();
    FT.requireAuth('../pages/payment.html' + location.search);

    const tx = FT.qsGet('tx', '');
    const sourceId = parseInt(FT.qsGet('source_id','0'), 10) || 0;

    async function init(){
      if (!tx) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô'); return; }
      try{
        // ‡πÅ‡∏™‡∏î‡∏á QR ‡∏à‡∏≤‡∏Å gateway
        const st = await FT.apiPaymentStatus(tx);
        document.getElementById('tx-status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + (st.status || 'CREATED');

        // ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ QR ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å endpoint ‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡∏≤‡∏Å gateway ‡∏°‡∏µ qr_code_url ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏Å‡∏£‡∏ì‡∏µ‡∏ô‡∏µ‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
        // ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á placeholder ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const qr = new Image();
        qr.width = 220; qr.height = 220;
        // ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        qr.src = st.qr_code_url || 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' + encodeURIComponent(tx);
        const box = document.getElementById('qr'); box.innerHTML = ''; box.appendChild(qr);
      }catch(e){ alert(e.message || e); }
    }

    document.getElementById('btn-verify').addEventListener('click', async ()=>{
      const slip = document.getElementById('slip-url').value.trim();
      if (!slip) return alert('‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ');
      try{
        await FT.apiVerifyPayment(tx, slip);
        document.getElementById('tx-status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: PENDING';
        const before = await FT.apiCredits();
        await FT.startCreditWatcher(before, (now)=>{
          alert('‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ' + now);
          const next = '../pages/draw.html' + (sourceId?`?source_id=${sourceId}`:'');
          FT.goto(next);
        });
      }catch(e){ alert(e.message || e); }
    });

    document.getElementById('btn-refresh').addEventListener('click', async ()=>{
      try{
        const st = await FT.apiPaymentStatus(tx);
        document.getElementById('tx-status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + (st.status || '-');
      }catch(e){ alert(e.message || e); }
    });

    init();
  </script>
</body>
</html>