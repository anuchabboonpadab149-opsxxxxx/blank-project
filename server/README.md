# Tarot App Backend (PromptPay via Omise)

This backend enables real PromptPay payments with automatic verification via Omise webhooks. It manages users, credits, orders, and QR code generation.

## Features

- User signup/login with token
- Credit management (1 credit per reading)
- Create PromptPay QR (Omise `source[type]=promptpay]`) for selected package
- Webhook handler that marks orders as paid and adds credits

## Requirements

1. Omise (Opn) account with PromptPay enabled
2. API Keys:
   - OMISE_SECRET_KEY
   - OMISE_PUBLIC_KEY
3. Webhook:
   - Configure a webhook URL pointing to `/api/webhooks/omise`
   - Set a webhook signing secret and use the same value for `WEBHOOK_SECRET` in `.env`

Note: PromptPay QR generated by Omise routes payments to your Omise merchant account (settled to your bank). Auto-verification requires using the PSP's webhook (Omise). Direct payments to a raw PromptPay phone cannot be auto-verified without bank/PSP API.

## Setup

```
cd server
cp .env.example .env
# Edit .env with your Omise keys and webhook secret

npm install
npm start
```

The server runs on `http://localhost:3000`.

## API

- GET `/api/health` — status
- GET `/api/packages` — list available packages
- POST `/api/signup` — `{name, phone, password}` => `{token}`
- POST `/api/login` — `{phone, password}` => `{token}`
- GET `/api/me` — requires `Authorization: Bearer <token>` => `{phone, name, credits}`
- POST `/api/credits/consume` — requires auth => decrements 1 credit
- POST `/api/topup/create-order` — requires auth and `{packageId}` => `{orderId, amount, credits, qrImage, chargeId}`
- GET `/api/orders/:orderId` — requires auth => `{id, status, amount, credits, charge_id}`
- POST `/api/webhooks/omise` — Omise webhook endpoint

## Frontend integration

Set `window.API_BASE` to the server origin (e.g. `http://localhost:3000`) before loading `app.js`, or ensure reverse-proxy exposes `/api` on the same origin.

The frontend calls:
- Signup/Login to get a token
- Fetch credits on page load
- Create orders to get QR image for PromptPay
- Poll order status; when `paid`, credits are available

## Deploy

- You can deploy this backend on Render, Railway, Fly.io, or any Node-capable host.
- Expose `/api/webhooks/omise` publicly and set it in the Omise dashboard.
- Keep `.env` secrets safe.

## Notes

- Passwords are stored as SHA-256 hashes (for demo). Switch to bcrypt or argon2 in production.
- DB: SQLite file at `server/database.sqlite`. Use Postgres/MySQL for production.
- Ensure CORS and HTTPS in production.