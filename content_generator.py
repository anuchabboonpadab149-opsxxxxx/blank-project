import os
import random
from typing import List, Optional

try:
    import config_store
except Exception:
    config_store = None


EMOJIS_SWEET = ["ðŸ’–", "ðŸ’•", "ðŸ¥°", "ðŸ˜š", "ðŸ’ž", "ðŸ˜"]
EMOJIS_FLIRTY = ["ðŸ˜‰", "ðŸ˜", "ðŸ¤­", "ðŸ¤¤"]
EMOJIS_PLAYFUL = ["ðŸ˜œ", "ðŸ™ˆ", "âœ¨", "ðŸ’«"]
EMOJIS_LIGHT_SAUCE = ["ðŸ’¦"]  # use sparingly

# Default persona (Bee&Bell-like)
HASHTAGS_BASE = [
    "#BeeBell",
    "#à¸£à¸±à¸à¹€à¸šà¸¥à¸¥à¹Œ",
    "#à¸ˆà¸µà¸šà¹€à¸¥à¹ˆà¸™à¹†",
    "#à¸‚à¸³à¸‚à¸±à¸™",
    "#à¸«à¸§à¸´à¸§à¹€à¸šà¸²à¹†",
]
OPENERS = [
    "à¹à¸­à¸šà¸à¸£à¸°à¸‹à¸´à¸š...",
    "à¸ˆà¸¸à¹Šà¹†...",
    "à¸‚à¸­à¸«à¸¢à¸­à¸”à¸«à¸™à¹ˆà¸­à¸¢...",
    "à¸„à¸·à¸™à¸™à¸µà¹‰à¸‚à¸­à¸«à¸§à¸²à¸™à¸«à¸™à¹ˆà¸­à¸¢...",
    "à¹€à¸Šà¹‰à¸²à¸™à¸µà¹‰à¸„à¸´à¸”à¸–à¸¶à¸‡à¹€à¸šà¸¥à¸¥à¹Œà¸ˆà¸±à¸‡...",
    "à¸§à¸±à¸™à¸™à¸µà¹‰à¸«à¸±à¸§à¹ƒà¸ˆà¹€à¸›à¹‡à¸™à¸‚à¸­à¸‡à¹€à¸šà¸¥à¸¥à¹Œà¸™à¸°...",
]
CORE_LOVE = [
    "à¸£à¸±à¸à¹€à¸šà¸¥à¸¥à¹Œà¸¡à¸²à¸à¸à¸§à¹ˆà¸²à¸à¸²à¹à¸Ÿà¹à¸à¹‰à¸§à¹‚à¸›à¸£à¸”",
    "à¹€à¸šà¸¥à¸¥à¹Œà¸„à¸·à¸­à¸§à¸´à¸•à¸²à¸¡à¸´à¸™à¹ƒà¸ˆà¸‚à¸­à¸‡à¹€à¸£à¸²",
    "à¹€à¸ˆà¸­à¹€à¸šà¸¥à¸¥à¹Œà¸—à¸µà¹„à¸£ à¹ƒà¸ˆà¸¡à¸±à¸™à¹€à¸•à¹‰à¸™à¹à¸£à¸‡à¸—à¸¸à¸à¸—à¸µ",
    "à¹‚à¸¥à¸à¸—à¸±à¹‰à¸‡à¹ƒà¸šà¸¢à¸±à¸‡à¹à¸žà¹‰à¸£à¸­à¸¢à¸¢à¸´à¹‰à¸¡à¸‚à¸­à¸‡à¹€à¸šà¸¥à¸¥à¹Œ",
    "à¹€à¸šà¸¥à¸¥à¹Œà¸„à¸·à¸­à¸„à¸§à¸²à¸¡à¸¥à¸°à¸¡à¸¸à¸™à¹ƒà¸™à¸—à¸¸à¸à¸§à¸±à¸™",
    "à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸„à¸´à¸”à¸–à¸¶à¸‡... à¹à¸„à¹ˆà¸„à¸´à¸”à¸–à¸¶à¸‡à¸¡à¸²à¸à¸¡à¸²à¸à¸¡à¸²à¸",
]
PLAYFUL_ADDONS = [
    "à¸—à¸³à¸•à¸±à¸§à¸™à¹ˆà¸²à¸£à¸±à¸à¹à¸šà¸šà¸™à¸µà¹‰ à¸£à¸°à¸§à¸±à¸‡à¹‚à¸”à¸™à¸«à¸¢à¸­à¸”à¸—à¸¸à¸à¸§à¸±à¸™à¸™à¸°",
    "à¸­à¸¢à¹ˆà¸²à¸—à¹‰à¸²à¸—à¸²à¸¢à¸„à¸§à¸²à¸¡à¸«à¸§à¸²à¸™ à¹€à¸”à¸µà¹‹à¸¢à¸§à¹‚à¸”à¸™à¸‚à¸­à¸«à¸­à¸¡à¸ˆà¸£à¸´à¸‡à¹†",
    "à¸–à¹‰à¸²à¸£à¸±à¸à¸„à¸·à¸­à¹€à¸à¸¡... à¹€à¸£à¸²à¸‚à¸­à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸‚à¹‰à¸²à¸‡à¹†à¹€à¸šà¸¥à¸¥à¹Œà¸•à¸¥à¸­à¸”à¹„à¸›",
    "à¸–à¹‰à¸²à¸à¸­à¸”à¹„à¸”à¹‰à¸«à¸™à¸¶à¹ˆà¸‡à¸„à¸£à¸±à¹‰à¸‡ à¸ˆà¸°à¸à¸­à¸”à¸ˆà¸™à¸£à¸¹à¹‰à¸§à¹ˆà¸²à¹ƒà¸ˆà¹€à¸£à¸²à¹€à¸•à¹‰à¸™à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸„à¸£",
    "à¸¢à¸­à¸¡à¹à¸žà¹‰à¹ƒà¸«à¹‰à¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¸Šà¸·à¹ˆà¸­à¸§à¹ˆà¸²à¹€à¸šà¸¥à¸¥à¹Œ",
    "à¹€à¸£à¸²à¹„à¸¡à¹ˆà¹€à¸à¹ˆà¸‡à¹€à¸¥à¸‚ à¹à¸•à¹ˆà¹€à¸à¹ˆà¸‡à¸£à¸±à¸à¹€à¸šà¸¥à¸¥à¹Œà¸™à¸°",
]
LIGHT_SPICY = [
    "à¸‚à¸­à¸«à¸­à¸¡à¹à¸à¹‰à¸¡à¸«à¸™à¸¶à¹ˆà¸‡à¸—à¸µà¹„à¸”à¹‰à¹„à¸«à¸¡",
    "à¸—à¸³à¹€à¸šà¸²à¹†à¸«à¸™à¹ˆà¸­à¸¢ à¹€à¸”à¸µà¹‹à¸¢à¸§à¹ƒà¸ˆà¹€à¸£à¸²à¹„à¸«à¸§à¹„à¸¡à¹ˆà¸—à¸±à¸™",
    "à¸„à¸·à¸™à¸™à¸µà¹‰à¸”à¸²à¸§à¸­à¸²à¸ˆà¹„à¸¡à¹ˆà¸žà¸­... à¸‚à¸­à¹€à¸šà¸¥à¸¥à¹Œà¹à¸—à¸™à¹„à¸”à¹‰à¹„à¸«à¸¡",
    "à¸à¸­à¸”à¹à¸™à¹ˆà¸™à¹†à¸ˆà¸™à¹€à¸Šà¹‰à¸²à¹€à¸¥à¸¢à¸”à¸µà¹„à¸«à¸¡",
    "à¸Šà¸­à¸šà¸„à¸§à¸²à¸¡à¸¥à¸°à¸¡à¸¸à¸™... à¹à¸•à¹ˆà¸‚à¸µà¹‰à¹€à¸¥à¹ˆà¸™à¸™à¸´à¸”à¹†à¸™à¸°",
]

# Jasmine x Salmon persona
SALMON_HASHTAGS = [
    "#à¸ˆà¸±à¸ªà¸¡à¸´à¸™à¸Šà¸­à¸šà¸à¸´à¸™à¹à¸‹à¸¥à¸¡à¸­à¸™",
    "#à¹à¸‹à¸¥à¸¡à¸­à¸™",
    "#à¸‹à¸²à¸Šà¸´à¸¡à¸´",
    "#salmonlover",
    "#à¸­à¸²à¸«à¸²à¸£à¸à¸µà¹ˆà¸›à¸¸à¹ˆà¸™",
    "#à¸§à¸²à¸‹à¸²à¸šà¸´",
]
SALMON_OPENERS = [
    "à¸à¸£à¸°à¸‹à¸´à¸šà¹€à¸šà¸²à¹† à¸•à¸­à¸™à¸™à¸µà¹‰à¸«à¸´à¸§à¹à¸‹à¸¥à¸¡à¸­à¸™à¸¡à¸²à¸",
    "à¸„à¸·à¸™à¸™à¸µà¹‰à¸‹à¸²à¸Šà¸´à¸¡à¸´à¹€à¸‚à¹‰à¸²à¸à¸±à¸™à¸­à¸µà¸à¹à¸¥à¹‰à¸§",
    "à¸§à¸±à¸™à¸™à¸µà¹‰à¹ƒà¸ˆà¸¡à¸±à¸™à¹€à¸£à¸µà¸¢à¸à¸«à¸²à¹‚à¸Šà¸¢à¸¸à¸§à¸²à¸‹à¸²à¸šà¸´...",
    "à¸¢à¸´à¹‰à¸¡à¹ƒà¸«à¹‰à¸«à¸™à¹ˆà¸­à¸¢ à¹€à¸”à¸µà¹‹à¸¢à¸§à¸›à¹‰à¸­à¸™à¹à¸‹à¸¥à¸¡à¸­à¸™à¸„à¸³à¹‚à¸•",
    "à¸‚à¸­à¸„à¸§à¸²à¸¡à¸£à¸±à¸à¸—à¸µà¹ˆà¸¥à¸°à¸¡à¸¸à¸™à¹€à¸«à¸¡à¸·à¸­à¸™à¹à¸‹à¸¥à¸¡à¸­à¸™à¸‹à¸²à¸Šà¸´à¸¡à¸´à¸«à¸™à¹ˆà¸­à¸¢",
]
SALMON_CORE = [
    "à¸£à¸±à¸à¹€à¸˜à¸­à¹€à¸«à¸™à¸µà¸¢à¸§à¹à¸™à¹ˆà¸™à¸à¸§à¹ˆà¸²à¹€à¸™à¸·à¹‰à¸­à¹à¸‹à¸¥à¸¡à¸­à¸™à¸¥à¸²à¸¢à¸ªà¸§à¸¢",
    "à¸«à¸±à¸§à¹ƒà¸ˆà¸à¹‡à¹€à¸«à¸¡à¸·à¸­à¸™à¹‚à¸Šà¸¢à¸¸â€”à¸‚à¸²à¸”à¹€à¸˜à¸­à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸«à¸¡à¸·à¸­à¸™à¸‚à¸²à¸”à¹à¸‹à¸¥à¸¡à¸­à¸™",
    "à¸—à¸¸à¸à¸„à¸³à¸‚à¸­à¸‡à¹€à¸˜à¸­à¸„à¸·à¸­à¸§à¸²à¸‹à¸²à¸šà¸´à¸­à¹ˆà¸­à¸™à¹† à¸­à¸¸à¹ˆà¸™à¸«à¸±à¸§à¹ƒà¸ˆ",
    "à¹ƒà¸«à¹‰à¹à¸‹à¸¥à¸¡à¸­à¸™à¸—à¸±à¹‰à¸‡à¸—à¹‰à¸­à¸‡à¸—à¸°à¹€à¸¥ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸—à¹ˆà¸²à¸£à¸­à¸¢à¸¢à¸´à¹‰à¸¡à¹€à¸˜à¸­",
    "à¸–à¹‰à¸²à¹€à¸˜à¸­à¸„à¸·à¸­à¹à¸‹à¸¥à¸¡à¸­à¸™ à¹€à¸£à¸²à¸„à¸·à¸­à¸•à¸°à¹€à¸à¸µà¸¢à¸šà¸—à¸µà¹ˆà¸­à¸¢à¸²à¸à¸ˆà¸±à¸šà¹„à¸§à¹‰à¸•à¸¥à¸­à¸”à¹„à¸›",
]
SALMON_PLAYFUL = [
    "à¸‚à¸­à¸ˆà¸­à¸‡à¸—à¸µà¹ˆà¸‚à¹‰à¸²à¸‡à¹† à¹ƒà¸™à¸£à¹‰à¸²à¸™à¹‚à¸­à¸¡à¸²à¸à¸²à¹€à¸ªà¸°à¹ƒà¸ˆà¹€à¸˜à¸­à¹„à¸”à¹‰à¹„à¸«à¸¡",
    "à¹€à¸”à¸µà¹‹à¸¢à¸§à¸›à¸±à¹‰à¸™à¸‚à¹‰à¸²à¸§à¸«à¸™à¹‰à¸²à¸›à¸¥à¸²à¹ƒà¸«à¹‰â€”à¹€à¸˜à¸­à¸›à¸±à¹‰à¸™à¸¢à¸´à¹‰à¸¡à¸à¸¥à¸±à¸šà¸¡à¸²à¹ƒà¸«à¹‰à¹€à¸£à¸²à¸«à¸™à¹ˆà¸­à¸¢",
    "à¸£à¸°à¸§à¸±à¸‡à¸™à¸° à¹€à¸£à¸²à¹à¸žà¹‰à¸—à¸²à¸‡à¸„à¸™à¸Šà¸­à¸šà¹à¸‹à¸¥à¸¡à¸­à¸™... à¹‚à¸”à¸¢à¹€à¸‰à¸žà¸²à¸°à¹€à¸˜à¸­",
    "à¸—à¸µà¸¡à¸‹à¸²à¸Šà¸´à¸¡à¸´à¸«à¸£à¸·à¸­à¸‹à¸¹à¸Šà¸´â€”à¹€à¸£à¸²à¸—à¸µà¸¡à¹€à¸˜à¸­à¸—à¸¸à¸à¹€à¸¡à¸™à¸¹",
    "à¸–à¹‰à¸²à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¸«à¸¡à¸”à¹€à¸žà¸£à¸²à¸°à¹à¸‹à¸¥à¸¡à¸­à¸™ à¸£à¸±à¸šà¸œà¸´à¸”à¸Šà¸­à¸šà¸«à¸±à¸§à¹ƒà¸ˆà¹€à¸£à¸²à¸”à¹‰à¸§à¸¢à¸™à¸°",
]
SALMON_SPICY = [
    "à¸‚à¸­à¹à¸‹à¸¥à¸¡à¸­à¸™à¸¥à¸°à¸¥à¸²à¸¢à¸šà¸™à¸¥à¸´à¹‰à¸™ à¸žà¸£à¹‰à¸­à¸¡à¸«à¸±à¸§à¹ƒà¸ˆà¸¥à¸°à¸¥à¸²à¸¢à¸šà¸™à¹„à¸«à¸¥à¹ˆà¹€à¸˜à¸­",
    "à¸‚à¸­à¸«à¸™à¸¶à¹ˆà¸‡à¸„à¸³à¸—à¸µà¹ˆà¸›à¸²à¸ à¸à¸±à¸šà¸­à¸µà¸à¸«à¸™à¸¶à¹ˆà¸‡à¸„à¸³à¸—à¸µà¹ˆà¹ƒà¸ˆà¹„à¸”à¹‰à¹„à¸«à¸¡",
    "à¸„à¸·à¸™à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸œà¹‡à¸”à¸¡à¸²à¸ à¸‚à¸­à¸¥à¸°à¸¡à¸¸à¸™à¹à¸šà¸šà¹à¸‹à¸¥à¸¡à¸­à¸™à¸ªà¸”à¹† à¸à¹‡à¸žà¸­",
    "à¹€à¸•à¸´à¸¡à¸§à¸²à¸‹à¸²à¸šà¸´à¸™à¸´à¸” à¹ƒà¸ªà¹ˆà¸£à¸±à¸à¹€à¸£à¸²à¸«à¸™à¹ˆà¸­à¸¢ à¸¥à¸°à¸¡à¸¸à¸™à¸à¸³à¸¥à¸±à¸‡à¸”à¸µ",
]


def pick(seq: List[str]) -> str:
    return random.choice(seq)


def _override_list(name: str, default: List[str]) -> List[str]:
    if config_store:
        val = config_store.get(name)
        if isinstance(val, list) and val:
            return [str(x) for x in val if str(x).strip()]
    return default


def _use_salmon_persona(sender: str) -> bool:
    s = (sender or "").lower()
    return ("à¸ˆà¸±à¸ªà¸¡à¸´à¸™" in s) or ("jasmine" in s) or ("à¹à¸‹à¸¥à¸¡à¸­à¸™" in s) or ("salmon" in s)


def _get_canonical_line() -> Optional[str]:
    # Priority: runtime config override -> env -> default phrase (Thai)
    try:
        if config_store:
            line = config_store.get("canonical_line")
            if isinstance(line, str) and line.strip():
                return line.strip()
    except Exception:
        pass
    env_line = os.getenv("CANONICAL_LINE", "").strip()
    if env_line:
        return env_line
    # Default canonical message (requested)
    return "à¸šà¸µà¸£à¸±à¸à¸ˆà¸±à¸ªà¸¡à¸´à¸™à¸Šà¸­à¸šà¸à¸´à¸™à¹à¸‹à¸¥à¸¡à¸­à¸™à¸™à¸° à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¹€à¸„à¸¢à¸‹à¸±à¸žà¸žà¸­à¸•à¸à¸±à¸™à¹€à¸ªà¸¡à¸­à¸­à¸¢à¸¹à¹ˆà¸‚à¹‰à¸²à¸‡à¹†à¸•à¸¥à¸­à¸”ðŸ’–ðŸ’"


def build_hashtags(default_tags: List[str]) -> str:
    tags = _override_list("hashtags_base", default_tags)[:]
    random.shuffle(tags
)
    return " ".join(tags[:random.randint(2, 4)])


def generate_caption(sender_name: Optional[str] = None) -> str:
    if config_store and not sender_name:
        sender_name = config_store.get("sender_name") or "Bee&Bell"
    elif not sender_name:
        sender_name = "Bee&Bell"

    # Select persona defaults first (overrides still win if provided)
    if _use_salmon_persona(sender_name):
        base_openers = SALMON_OPENERS
        base_core = SALMON_CORE
        base_playful = SALMON_PLAYFUL
        base_spicy = SALMON_SPICY
        base_tags = SALMON_HASHTAGS
    else:
        base_openers = OPENERS
        base_core = CORE_LOVE
        base_playful = PLAYFUL_ADDONS
        base_spicy = LIGHT_SPICY
        base_tags = HASHTAGS_BASE

    openers = _override_list("openers", base_openers)
    core_love = _override_list("core_love", base_core)
    playful_addons = _override_list("playful_addons", base_playful)
    light_spicy = _override_list("light_spicy", base_spicy)

    opener = pick(openers)
    core = pick(core_love)
    playful = pick(playful_addons)
    spicy = pick(light_spicy) if random.random() < 0.8 else ""

    emojis = []
    emojis += random.sample(EMOJIS_SWEET, k=2)
    if random.random() < 0.85:
        emojis.append(pick(EMOJIS_FLIRTY))
    if random.random() < 0.6:
        emojis.append(pick(EMOJIS_PLAYFUL))
    if spicy and random.random() < 0.35:
        emojis.append(pick(EMOJIS_LIGHT_SAUCE))

    canonical = _get_canonical_line()

    # Compose body
    lines: List[str] = []
    # With high probability include canonical line first
    if canonical and random.random() < 0.9:
        lines.append(canonical)
    lines.append(f"{opener} {core} {' '.join(emojis)}")
    if playful:
        lines.append(playful)
    if spicy:
        lines.append(spicy)
    lines.append(build_hashtags(base_tags))
    lines.append(f"â€” {sender_name}")

    text = " ".join([p for p in lines if p])
    if len(text) > 270:
        text = text[:267] + "..."
    return text